<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <!-- ‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏¥‡∏á /favicon.ico ‡πÅ‡∏•‡πâ‡∏ß 404 -->
  <link rel="icon" href="data:,">

  <!-- ‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <!-- Top bar -->
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices‚Ä¶</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">‚ü≥</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero + Title -->
    <div class="hero"><img src="./assets/organic.png" alt="organic"></div>
    <div class="center">
      <div class="title">Peak Protein</div>
      <div class="sub">Level <span id="growthLevel">-</span></div>
    </div>

    <!-- Progress -->
    <div class="progress-lite">
      <div class="track"><div id="barFill" class="fill"></div></div>
      <div class="pct"><span id="pctTop">0</span>%</div>
    </div>

    <!-- Status Card -->
    <section class="card" id="statusCard">
      <h3>Status</h3>
      <ul class="metrics">
        <li>
          <div class="metric-left">
            <div class="ic">üçÉ</div><div>Chlorophyll</div>
          </div>
          <div class="val" id="mChl">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üíß</div><div>Soil pH</div>
          </div>
          <div class="val" id="mPh">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üå°Ô∏è</div><div>Temp</div>
          </div>
          <div class="val" id="mTemp">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">‚ö°</div><div>Soil EC</div>
          </div>
          <div class="val" id="mEc">‚Äî</div>
        </li>
      </ul>
    </section>

    <!-- Big CTA -->
    <button id="ctaState" class="cta">Not Ready Yet</button>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î + debug -->
    <div id="status" style="color:#fff; margin:10px 4px;"></div>
    <pre id="out" class="log">‚Äî</pre>
  </main>
  <section class="dashboard" id="dashboard" hidden>
<div class="dash-hero">
  <div>
    <h1>Overview</h1>
    <div class="dash-kpis">
      <div class="dkpi"><small>Water </small><b id="dkpi-water">‚Äî</b></div>
      <div class="dkpi"><small>pH Level </small><b id="dkpi-ph">‚Äî</b></div>
      <div class="dkpi"><small>Temperature (¬∞C)</small><b id="dkpi-temp">‚Äî</b></div>
    </div>
  </div>
  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û/‡∏™‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ -->
  <div class="dash-plant" aria-hidden="true"></div>
</div>

<!-- PANELS (3 ‡πÉ‡∏ö) -->
<div class="dash-panels">
  <!-- ‡∏ã‡πâ‡∏≤‡∏¢: Growth analytics (‡πÄ‡∏Ç‡πâ‡∏°) -->
  <div class="dash-card growth">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Growth analytics</h3>
      <button class="dash-btn" onclick="/* ‡∏ï‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ details ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ */">Details</button>
    </div>
    <div class="dash-spark">
      <canvas id="spark" width="800" height="220" aria-label="pH & Temp chart"></canvas>
    </div>
    <div class="legend" style="margin-top:8px;font-size:12px;">
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#16a34a;margin-right:6px;"></span> pH
      &nbsp;&nbsp;
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2563eb;margin-right:6px;"></span> Temp
    </div>
  </div>

  <!-- ‡∏Å‡∏•‡∏≤‡∏á: Critical Alerts (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) -->
  <div class="dash-card alerts">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Critical Alerts</h3>
      <a href="javascript:void(0)" style="font-size:13px;">View all</a>
    </div>
    <ul class="dash-alerts" id="dash-alerts">
      <li><span class="ok"></span> Optimal growth</li>
      <li><span class="warn"></span> Low water level</li>
      <li><span class="bad"></span> pH above normal</li>
    </ul>
  </div>

  <!-- ‡∏Ç‡∏ß‡∏≤: Activity Overview -->
  <div class="dash-card activity">
    <h3>Activity Overview</h3>
    <div class="dash-activity" id="dash-activity">
      <div class="dash-evt"><div><b>Watering System Adjustment</b><div><small>10:00‚Äì11:00</small></div></div><button class="dash-btn">Details</button></div>
      <div class="dash-evt"><div><b>Fertilizer Check</b><div><small>12:00‚Äì12:30</small></div></div><small>Completed</small></div>
      <div class="dash-evt"><div><b>Lighting Adjustment</b><div><small>16:00‚Äì18:00</small></div></div><small>In Progress</small></div>
    </div>
  </div>
</div>
</section>
<script>
/* ===================== ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ===================== */
const LIFF_ID = '2008085765-YDwJrxy9';
const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

/* ===================== DOM refs ===================== */
const $ = (id) => document.getElementById(id);
const statusEl = $('status');
const out = $('out');

const barFill = $('barFill');
const pctTop = $('pctTop');
const growthLevel = $('growthLevel');
const cta = $('ctaState');

const metricEls = { chl: $('mChl'), ph: $('mPh'), temp: $('mTemp'), ec: $('mEc') };

/* ===================== Utils ===================== */
function showError(err){
  console.error(err);
  const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
  if (statusEl) statusEl.textContent = 'Error: ' + msg;
  if (out) { out.style.display = 'block'; out.textContent = msg; }
}

function normalizeLevel(lvl){
  if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
  if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
    const n = parseInt(lvl, 10);
    return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
  }
  if (String(lvl).toLowerCase().includes('ready')) return '4';
  return String(lvl || '-');
}

function pickUpdated(d){
  if (d?.updatedAtIso) return d.updatedAtIso;
  const u = d?.updatedAt;
  if (!u) return '‚Äî';
  if (typeof u === 'string') return u;
  if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
  return String(u);
}

/* ===== ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å shadow ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠) ===== */
function getNum(obj, keys){
  const all = Object.keys(obj || {});
  const canon = s => String(s||'').toLowerCase();
  for (const k of all){
    const ck = canon(k);
    if (keys.some(q => ck.includes(canon(q)))){
      const v = Number(obj[k]);
      if (!Number.isNaN(v)) return v;
    }
  }
  for (const k of all){
    if (obj[k] && typeof obj[k] === 'object'){
      const v = getNum(obj[k], keys);
      if (typeof v === 'number') return v;
    }
  }
  return null;
}

function setMetric(el, val, suffix=''){
  if (!el) return;
  el.textContent = (val==null || Number.isNaN(val)) ? '‚Äî' : (suffix ? `${val}${suffix}` : String(val));
}

/* ===================== LINE Auth helpers ===================== */
function stripRedirectUri() { 
  return location.origin + location.pathname; 
}

async function ensureLogin() {
  if (liff.isLoggedIn()) return;
  const redirectUri = stripRedirectUri();
  if (liff.isInClient()) {
    liff.login();
  } else {
    liff.login({ withLoginOnExternalBrowser: true, redirectUri });
  }
  return new Promise(()=>{});
}

function buildAuthHeaders(){
  const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
  const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
  const h = { 'Content-Type': 'application/json' };
  if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
  else if (access) h['x-line-access-token'] = access;
  else throw new Error('No LINE token available');
  return h;
}

async function authedGet(url){
  const r = await fetch(url, { headers: buildAuthHeaders() });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.error) throw new Error(j.error || t);
  return j;
}

async function authedPost(url, body){
  const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
  return j;
}

/* ===================== Formatters (DKPI) ===================== */
const formatPh   = p => (p==null || Number.isNaN(+p)) ? '‚Äî' : (+p).toFixed(1);
const formatTemp = t => (t==null || Number.isNaN(+t)) ? '‚Äî' : `${(+t).toFixed(1)}¬∞C`;
function formatWater(w){
  if (w==null || Number.isNaN(+w)) return '‚Äî';
  const n = +w;
  if (n <= 1)   return `${Math.round(n*100)}%`; // 0..1
  if (n <= 100) return `${Math.round(n)}%`;     // 0..100
  return String(n);
}

/* ===================== APIs (Progress/Shadow) ===================== */
async function getProgress(deviceId){
  const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
  const r = await fetch(url, { cache:'no-store' }); 
  const j = await r.json();
  if (!r.ok || j.error) throw new Error(j.error || JSON.stringify(j));
  return j; // {percent, level, goodNow, ...}
}

async function loadProgress(deviceId){
  const data = await getProgress(deviceId);
  const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
  const lvl = normalizeLevel(data.level);
  const good = ('Status' in data) ? !!data.Status : !!data.goodNow;
  const updated = pickUpdated(data);

  if (pctTop) pctTop.textContent = pct!=null ? pct.toFixed(1) : '‚Äî';
  if (barFill) barFill.style.width = pct!=null ? `${pct}%` : '0%';
  if (growthLevel) growthLevel.textContent = lvl;
  if (cta){
    cta.textContent = good ? 'Ready!' : 'Not Ready Yet';
    cta.classList.toggle('ready', good);
  }
  if (statusEl) statusEl.textContent = `Updated: ${updated}`;
}

async function loadShadow(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid rev modified data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  if (out) out.textContent = JSON.stringify(r.data, null, 2);   // debug (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô UI ‡∏à‡∏£‡∏¥‡∏á)
  const data = r?.data?.shadow?.data || {};

  const chl  = getNum(data, ['chloro','chlorophyll','par','ndvi','leaf']);
  const ph   = getNum(data, ['soil_ph','pH','ph']);
  const temp = getNum(data, ['temp','temperature','temp_c']);
  const ec   = getNum(data, ['soil_ec','ec','conductivity']);

  setMetric(metricEls.chl,  chl!=null ? +chl.toFixed(1) : null);
  setMetric(metricEls.ph,   ph!=null ? +ph.toFixed(2) : null);
  setMetric(metricEls.temp, temp!=null ? +temp.toFixed(1) : null, '¬∞C');
  setMetric(metricEls.ec,   ec!=null ? +ec.toFixed(3) : null);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå + ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
  updateSeries(deviceId, typeof ph==='number'?ph:null, typeof temp==='number'?temp:null);
  drawSpark(deviceId);

  return { data, ph, temp };
}

/* ===================== DKPI (‡∏ö‡∏ô Hero) ===================== */
async function renderDkpiForDevice(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};

  const water = getNum(data, ['water_level','water','level','wl','water_percent','waterPct']);
  const ph    = getNum(data, ['soil_ph','pH','ph']);
  const temp  = getNum(data, ['temp','temperature','temp_c']);

  $('dkpi-water') && ($('dkpi-water').textContent = formatWater(water));
  $('dkpi-ph')    && ($('dkpi-ph').textContent    = formatPh(ph));
  $('dkpi-temp')  && ($('dkpi-temp').textContent  = formatTemp(temp));

  localStorage.setItem('deviceId', deviceId);
}

/* ===================== Sparkline (pH & Temp) ===================== */
const SERIES_MAX = 120; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ~120 ‡∏à‡∏∏‡∏î
function seriesKey(deviceId){ return 'series_' + deviceId; }
function loadSeries(deviceId){
  try{ return JSON.parse(localStorage.getItem(seriesKey(deviceId))) || {t:[], ph:[], temp:[]}; }
  catch{ return {t:[], ph:[], temp:[]}; }
}
function saveSeries(deviceId, s){ localStorage.setItem(seriesKey(deviceId), JSON.stringify(s)); }
function updateSeries(deviceId, ph, temp){
  if (!deviceId || (ph==null && temp==null)) return;
  const s = loadSeries(deviceId);
  const now = Date.now();
  if (s.t.length && now - s.t[s.t.length-1] < 50*1000) {
    if (typeof ph   === 'number') s.ph[s.ph.length-1]     = ph;
    if (typeof temp === 'number') s.temp[s.temp.length-1] = temp;
  } else {
    s.t.push(now); s.ph.push(typeof ph==='number'?ph:null); s.temp.push(typeof temp==='number'?temp:null);
  }
  while (s.t.length > SERIES_MAX){ s.t.shift(); s.ph.shift(); s.temp.shift(); }
  saveSeries(deviceId, s);
}
function drawSpark(deviceId){
  const c = document.getElementById('spark'); if (!c) return;
  const dpr = window.devicePixelRatio || 1;
  const cssW = c.clientWidth || 600, cssH = 180;
  c.width = Math.floor(cssW * dpr); c.height = Math.floor(cssH * dpr);
  const ctx = c.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  const s = loadSeries(deviceId);
  const n = s.t.length; if (!n) return;

  const pad = {l:36, r:6, t:12, b:18};
  const iw = cssW - pad.l - pad.r, ih = cssH - pad.t - pad.b;
  const idxs = [...Array(n).keys()];

  const phVals = s.ph.filter(v=>typeof v==='number');
  const phMin = phVals.length ? Math.min(5, ...phVals) : 5;
  const phMax = phVals.length ? Math.max(9, ...phVals) : 9;

  const tVals = s.temp.filter(v=>typeof v==='number');
  const tMin = tVals.length ? Math.min(20, ...tVals) : 20;
  const tMax = tVals.length ? Math.max(35, ...tVals) : 35;

  const xAt = i => pad.l + (i/(Math.max(1,n-1))) * iw;
  const yAt = (val,min,max) => pad.t + (1 - ((val-min)/(max-min || 1))) * ih;

  // grid
  ctx.strokeStyle = '#e5efe9'; ctx.lineWidth = 1;
  for (let g=0; g<=4; g++){ const y = pad.t + g*(ih/4); ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+iw,y); ctx.stroke(); }

  // pH line (green)
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2; ctx.beginPath();
  let moved=false;
  idxs.forEach(i=>{
    const v = s.ph[i]; if (typeof v!=='number') return;
    const x=xAt(i), y=yAt(v,phMin,phMax);
    if (!moved){ ctx.moveTo(x,y); moved=true; } else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Temp line (blue)
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.beginPath();
  moved=false;
  idxs.forEach(i=>{
    const v = s.temp[i]; if (typeof v!=='number') return;
    const x=xAt(i), y=yAt(v,tMin,tMax);
    if (!moved){ ctx.moveTo(x,y); moved=true; } else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // labels
  ctx.fillStyle = '#4b6a5d'; ctx.font = '12px system-ui';
  ctx.fillText(`pH ${phMin.toFixed(1)}‚Äì${phMax.toFixed(1)}`, pad.l, 12);
  ctx.textAlign='right';
  ctx.fillText(`Temp ${tMin.toFixed(0)}‚Äì${tMax.toFixed(0)}¬∞C`, pad.l+iw, 12);
}

/* ===================== Dashboard (Desktop) ===================== */
async function renderDashboard(){
  if (!window.matchMedia('(min-width:960px)').matches) return;
  const dash = $('dashboard'); if (dash) dash.hidden = false;

  const resp = await authedGet('/api/devices');
  const devices = Array.isArray(resp?.devices) ? resp.devices : [];

  const tbody = document.querySelector('#dash-table tbody'); 
  if (tbody) tbody.innerHTML = '';

  for (const d of devices){
    const tr = document.createElement('tr');
    const td = v => { const el=document.createElement('td'); el.textContent=v; return el; };

    let percentTxt = '‚Äî', health='‚Äî', dotCls='bad';
    try{
      const p = await getProgress(d.deviceId);
      if (typeof p.percent === 'number'){
        const pct = Math.round(p.percent);
        percentTxt = `${pct}%`;
        health = (pct>=80?'A+':pct>=60?'B':'C');
        dotCls = (pct>=80?'ok':pct>=60?'warn':'bad');
      }
    }catch{}

    let phTxt='‚Äî', tempTxt='‚Äî';
    try{
      const Q='query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
      const r=await authedPost('/api/gql',{query:Q,variables:{deviceid:d.deviceId}});
      const data=r?.data?.shadow?.data || {};
      const _ph = getNum(data,['soil_ph','pH','ph']);             if (typeof _ph === 'number') phTxt   = _ph.toFixed(1);
      const _t  = getNum(data,['temp','temperature','temp_c']);   if (typeof _t === 'number') tempTxt = _t.toFixed(1)+'¬∞C';
    }catch{}

    const healthTd=document.createElement('td');
    const wrap=document.createElement('div'); wrap.className='dash-health';
    const dot=document.createElement('span'); dot.className='dot '+dotCls;
    const badge=document.createElement('span'); badge.className='dash-badge'; badge.textContent=health;
    wrap.append(dot,' ',badge); healthTd.appendChild(wrap);

    tr.append(healthTd, td(d.name||d.deviceId), td(percentTxt), td(phTxt), td(tempTxt));

    const btn=document.createElement('button'); btn.className='dash-btn'; btn.textContent='Select';
    btn.onclick = () => renderDkpiForDevice(d.deviceId).catch(console.error);
    const action=document.createElement('td'); action.appendChild(btn); tr.appendChild(action);

    tbody && tbody.appendChild(tr);
  }

  const initial = localStorage.getItem('deviceId') || devices[0]?.deviceId;
  if (initial) await renderDkpiForDevice(initial);
}

/* ===================== Boot ===================== */
window.addEventListener('DOMContentLoaded', async () => {
  try{
    await liff.init({ liffId: LIFF_ID });
    await ensureLogin();

    // clear LIFF query
    {
      const qs = new URLSearchParams(location.search);
      if (qs.get('code') || qs.get('liffRedirectUri')) {
        history.replaceState({}, '', stripRedirectUri());
      }
    }

    // cache token
    const idToken = liff.getIDToken();
    const accessToken = liff.getAccessToken();
    if (idToken) sessionStorage.setItem('line_id_token', idToken);
    if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

    const sel = $('deviceSelect');

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    let devices = [];
    try{
      const resp = await authedGet('/api/devices');
      devices = Array.isArray(resp?.devices) ? resp.devices : [];
    }catch(e){ showError(e); }

    if (sel){
      sel.innerHTML = '';
      if (devices.length === 0){
        const op = document.createElement('option');
        op.value = ''; op.textContent = 'No device';
        sel.appendChild(op);
      }else{
        devices.forEach(d=>{
          const op = document.createElement('option');
          op.value = d.deviceId; op.textContent = d.name || d.deviceId;
          sel.appendChild(op);
        });
        const saved = localStorage.getItem('deviceId');
        if (saved && [...sel.options].some(o=>o.value===saved)) sel.value = saved;
      }
    }

    async function refreshAll(){
      if (!sel?.value) { if (statusEl) statusEl.textContent = 'Select a device first'; return; }
      if (statusEl) statusEl.textContent = 'Loading‚Ä¶';
      try{
        await loadShadow(sel.value);
        await loadProgress(sel.value);
        if (statusEl) statusEl.textContent = 'Updated';
      }catch(e){ showError(e); }
    }

    $('refreshBtn') && ($('refreshBtn').onclick = refreshAll);

    sel && (sel.onchange = async ()=>{
      localStorage.setItem('deviceId', sel.value || '');
      await refreshAll();
      if (window.matchMedia('(min-width:960px)').matches && sel.value){
        renderDkpiForDevice(sel.value).catch(console.error);
      }
    });

    await refreshAll();

    // refresh ‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥
    setInterval(()=> {
      if (!sel?.value) return;
      loadProgress(sel.value).catch(showError);
      loadShadow(sel.value).catch(showError);
    }, 60000);

    // dashboard (desktop)
    setTimeout(()=>renderDashboard().catch(console.error), 500);

    // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (sel?.value) drawSpark(sel.value);

  }catch(e){ showError(e); }
});
</script>
</body>
</html>