<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <link rel="icon" href="data:,">
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices…</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">⟳</button>
    </div>
  </header>
<section class="dashboard" id="dashboard" hidden>
  <div class="dash-hero">
    <div>
      <h1>Overview</h1>
     <!-- Level + Progress -->
      <div class="dash-level">Level <span id="growthLevelDash" class="level">-</span></div>
      <div class="progress-lite dash-progress">
        <div class="track"><div id="barFillDash" class="fill"></div></div>
        <div class="pct"><span id="pctTopDash">0</span>%</div>
      </div>

      <!-- KPIs -->
<div class="dash-kpis">
  <!-- Water (filled path) -->
  <div class="dkpi kpi-water">
    <svg class="kpi-ic" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M12 2s6 6.8 6 10a6 6 0 1 1-12 0C6 8.8 12 2 12 2Z"/>
    </svg>
    <small>Water</small>
    <b id="dkpi-water">—</b>
  </div>

  <!-- pH (beaker – stroke paths only) -->
  <div class="dkpi kpi-ph">
    <svg class="kpi-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
      <!-- โครงบีกเกอร์ -->
      <path d="M7 3h10M13 3v6l3.6 7.2A2 2 0 0 1 14.8 19H9.2a2 2 0 0 1-1.8-2.8L11 9V3"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- เส้นระดับของเหลว -->
      <path d="M9 13c1.8 1 3.6 1 6 0" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <small>pH Level</small>
    <b id="dkpi-ph">—</b>
  </div>

  <!-- Temperature (thermometer – ทุกเส้นเป็น path) -->
  <div class="dkpi kpi-temp">
    <svg class="kpi-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
      <!-- ลำตัวเทอร์โมมิเตอร์ -->
      <path d="M14.75 14.78V5.58a3.67 3.67 0 0 0-7.33 0v9.2A4.53 4.53 0 1 0 15.67 17.5a4.53 4.53 0 0 0-.92-2.72Z"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- แกนกลาง -->
      <path d="M11.08 5.58v11" stroke-width="2" stroke-linecap="round"/>
      <!-- ขีดสเกลด้านขวา (เป็น path ทั้งหมด) -->
      <path d="M14.75 6.5h2.75M14.75 10.17h2.75M14.75 13.83h2.75"
            stroke-width="2" stroke-linecap="round"/>
    </svg>
    <small>Temperature (°C)</small>
    <b id="dkpi-temp">—</b>
  </div>
</div>
      </div>
    </div>              <!-- ✅ ปิด div ชั้นใน -->
  </div>       

    <!-- Panels -->
    <div class="dash-panels">
      <div class="dash-card growth">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Growth analytics</h3>
        </div>
        <div class="dash-spark">
          <canvas id="spark" width="800" height="220" aria-label="pH & Temp chart"></canvas>
        </div>
        <div class="legend" style="margin-top:8px;font-size:12px;">
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#16a34a;margin-right:6px;"></span> pH
          &nbsp;&nbsp;
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2563eb;margin-right:6px;"></span> Temp
        </div>
      </div>

      <div class="dash-card alerts">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Critical Alerts</h3>
        </div>
        <ul class="dash-alerts" id="dash-alerts">
          <li><span class="ok"></span> Optimal growth</li>
          <li><span class="warn"></span> Low water level</li>
          <li><span class="bad"></span> pH above normal</li>
        </ul>
      </div>

      <div class="dash-card activity">
        <h3>Activity Overview</h3>
        <div class="dash-activity" id="dash-activity">
          <div class="dash-evt"><div><b>Watering System Adjustment</b><div><small>10:00–11:00</small></div></div><button class="dash-btn">Details</button></div>
          <div class="dash-evt"><div><b>Fertilizer Check</b><div><small>12:00–12:30</small></div></div><small>Completed</small></div>
          <div class="dash-evt"><div><b>Lighting Adjustment</b><div><small>16:00–18:00</small></div></div><small>In Progress</small></div>
        </div>
      </div>
    </div>
  </section>

<script>
/* ========== Config ========== */
const LIFF_ID = '2008085765-YDwJrxy9';
const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

/* ========== DOM helpers ========== */
const $ = (id) => document.getElementById(id);
const barFillDash = $('barFillDash');
const pctTopDash = $('pctTopDash');
const growthLevelDash = $('growthLevelDash');

/* ========== Utils ========== */
function showError(err){ console.error(err); }
function normalizeLevel(lvl){
  if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
  if (typeof lvl === 'string' && /^\d+$/.test(lvl)) { const n = parseInt(lvl,10); return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl; }
  if (String(lvl).toLowerCase().includes('ready')) return '4';
  return String(lvl || '-');
}
function pickUpdated(d){
  if (d?.updatedAtIso) return d.updatedAtIso;
  const u = d?.updatedAt;
  if (!u) return '—';
  if (typeof u === 'string') return u;
  if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds*1000).toISOString();
  return String(u);
}
function getNum(obj, keys){
  const all = Object.keys(obj || {}), canon = s => String(s||'').toLowerCase();
  for (const k of all){ const ck = canon(k); if (keys.some(q => ck.includes(canon(q)))){ const v = Number(obj[k]); if (!Number.isNaN(v)) return v; } }
  for (const k of all){ if (obj[k] && typeof obj[k] === 'object'){ const v = getNum(obj[k], keys); if (typeof v === 'number') return v; } }
  return null;
}

/* ========== LINE Auth ========== */
function stripRedirectUri(){ return location.origin + location.pathname; }
async function ensureLogin(){
  if (liff.isLoggedIn()) return;
  const redirectUri = stripRedirectUri();
  if (liff.isInClient()) liff.login();
  else liff.login({ withLoginOnExternalBrowser:true, redirectUri });
  return new Promise(()=>{});
}
function buildAuthHeaders(){
  const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
  const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
  const h = { 'Content-Type':'application/json' };
  if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
  else if (access) h['x-line-access-token'] = access;
  else throw new Error('No LINE token available');
  return h;
}
async function authedGet(url){
  const r = await fetch(url, { headers: buildAuthHeaders() });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.error) throw new Error(j.error || t);
  return j;
}
async function authedPost(url, body){
  const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
  return j;
}

/* ========== Formatters (DKPI) ========== */
const formatPh   = p => (p==null || Number.isNaN(+p)) ? '—' : `${(+p).toFixed(1)} pH`;
const formatTemp = t => (t==null || Number.isNaN(+t)) ? '—' : `${(+t).toFixed(1)}°C`;
function formatWater(w){
  if (w==null || Number.isNaN(+w)) return '—';
  const n = +w; if (n <= 1) return `${Math.round(n*100)}%`; if (n <= 100) return `${Math.round(n)}%`; return String(n);
}

/* ========== APIs ========== */
async function getProgress(deviceId){
  const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
  const r = await fetch(url, { cache:'no-store' }); const j = await r.json();
  if (!r.ok || j.error) throw new Error(j.error || JSON.stringify(j));
  return j;
}
async function loadProgress(deviceId){
  const data = await getProgress(deviceId);
  const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
  const lvl = normalizeLevel(data.level);
  if (pctTopDash) pctTopDash.textContent = pct!=null ? pct.toFixed(1) : '—';
  if (barFillDash) barFillDash.style.width = pct!=null ? `${pct}%` : '0%';
  if (growthLevelDash) growthLevelDash.textContent = lvl;
}
async function loadShadow(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};
  const ph   = getNum(data, ['soil_ph','pH','ph']);
  const temp = getNum(data, ['temp','temperature','temp_c']);
  updateSeries(deviceId, typeof ph==='number'?ph:null, typeof temp==='number'?temp:null);
  drawSpark(deviceId);
  return { data, ph, temp };
}
async function renderDkpiForDevice(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};
  const water = getNum(data, ['water_level','water','level','wl','water_percent','waterPct']);
  const ph    = getNum(data, ['soil_ph','pH','ph']);
  const temp  = getNum(data, ['temp','temperature','temp_c']);
  $('dkpi-water').textContent = formatWater(water);
  $('dkpi-ph').textContent    = formatPh(ph);
  $('dkpi-temp').textContent  = formatTemp(temp);
  localStorage.setItem('deviceId', deviceId);
}

/* ========== Sparkline (pH & Temp) ========== */
const SERIES_MAX = 120;
function seriesKey(deviceId){ return 'series_' + deviceId; }
function loadSeries(deviceId){ try{ return JSON.parse(localStorage.getItem(seriesKey(deviceId))) || {t:[],ph:[],temp:[]}; }catch{ return {t:[],ph:[],temp:[]}; } }
function saveSeries(deviceId, s){ localStorage.setItem(seriesKey(deviceId), JSON.stringify(s)); }
function updateSeries(deviceId, ph, temp){
  if (!deviceId || (ph==null && temp==null)) return;
  const s = loadSeries(deviceId); const now = Date.now();
  if (s.t.length && now - s.t[s.t.length-1] < 50*1000){
    if (typeof ph==='number') s.ph[s.ph.length-1] = ph;
    if (typeof temp==='number') s.temp[s.temp.length-1] = temp;
  }else{
    s.t.push(now); s.ph.push(typeof ph==='number'?ph:null); s.temp.push(typeof temp==='number'?temp:null);
  }
  while (s.t.length > SERIES_MAX){ s.t.shift(); s.ph.shift(); s.temp.shift(); }
  saveSeries(deviceId, s);
}
function drawSpark(deviceId){
  const c = document.getElementById('spark'); if (!c) return;
  const rect = c.getBoundingClientRect();
  const cssW = Math.max(1, Math.floor(rect.width));
  const cssH = Math.max(1, Math.floor(rect.height));
  const dpr  = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  if (c.width!==cssW*dpr) c.width = cssW*dpr;
  if (c.height!==cssH*dpr) c.height = cssH*dpr;

  const ctx = c.getContext('2d');
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,cssW,cssH);

  const s = loadSeries(deviceId); const n = s.t.length; if (!n) return;
  const pad = {l:40,r:10,t:18,b:24}, iw = cssW-pad.l-pad.r, ih = cssH-pad.t-pad.b;
  const clamp = (v,lo,hi)=>Math.min(hi,Math.max(lo,v));
  const phVals = s.ph.filter(v=>typeof v==='number');
  let phMin = phVals.length?Math.min(...phVals):7, phMax = phVals.length?Math.max(...phVals):7;
  if (phMax===phMin){ phMax+=.1; phMin-=.1; }
  const phPad=(phMax-phMin)*.15+.1; phMin=clamp(phMin-phPad,0,14); phMax=clamp(phMax+phPad,.1,14);
  const tVals = s.temp.filter(v=>typeof v==='number');
  let tMin = tVals.length?Math.min(...tVals):25, tMax = tVals.length?Math.max(...tVals):25;
  if (tMax===tMin){ tMax+=.5; tMin-=.5; }
  const tPad=(tMax-tMin)*.15+.5; tMin=Math.max(0,tMin-tPad); tMax=tMax+tPad;
  const xAt=i=>pad.l+(i/Math.max(1,n-1))*iw, yAt=(v,min,max)=>pad.t+(1-((clamp(v,min,max)-min)/(max-min)))*ih;

  ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.lineWidth=1;
  for(let g=0; g<=4; g++){ const y=pad.t+g*(ih/4); ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+iw,y); ctx.stroke(); }

  const line=(arr,min,max,color)=>{ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); let moved=false;
    for(let i=0;i<n;i++){ const v=arr[i]; if(typeof v!=='number') continue; const x=xAt(i), y=yAt(v,min,max); if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y); }
    if(moved) ctx.stroke();
  };
  line(s.ph, phMin, phMax, '#34d399');   // pH
  line(s.temp, tMin, tMax, '#60a5fa');   // Temp

  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
  ctx.textAlign='left';  ctx.fillText(`pH ${phMin.toFixed(1)}–${phMax.toFixed(1)}`, pad.l, pad.t-4);
  ctx.textAlign='right'; ctx.fillText(`Temp ${Math.round(tMin)}–${Math.round(tMax)}°C`, pad.l+iw, pad.t-4);
}

/* ========== Boot ========== */
window.addEventListener('DOMContentLoaded', async () => {
  try{
    await liff.init({ liffId: LIFF_ID });
    await ensureLogin();

    const qs = new URLSearchParams(location.search);
    if (qs.get('code') || qs.get('liffRedirectUri')) history.replaceState({}, '', stripRedirectUri());

    const idToken = liff.getIDToken(); const accessToken = liff.getAccessToken();
    if (idToken) sessionStorage.setItem('line_id_token', idToken);
    if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

    const sel = $('deviceSelect');

    // devices
    let devices = [];
    try{ const resp = await authedGet('/api/devices'); devices = Array.isArray(resp?.devices)?resp.devices:[]; }
    catch(e){ showError(e); }

    if (sel){
      sel.innerHTML='';
      if (devices.length===0){
        const op=document.createElement('option'); op.value=''; op.textContent='No device'; sel.appendChild(op);
      }else{
        devices.forEach(d=>{ const op=document.createElement('option'); op.value=d.deviceId; op.textContent=d.name||d.deviceId; sel.appendChild(op); });
        const saved = localStorage.getItem('deviceId'); if (saved && [...sel.options].some(o=>o.value===saved)) sel.value=saved;
      }
    }

    async function refreshAll(){
      if (!sel?.value) return;
      await Promise.all([ loadShadow(sel.value), loadProgress(sel.value), renderDkpiForDevice(sel.value) ]);
      $('dashboard').hidden = false;
    }

    $('refreshBtn') && ($('refreshBtn').onclick = refreshAll);
    sel && (sel.onchange = async ()=>{ localStorage.setItem('deviceId', sel.value||''); await refreshAll(); });

    await refreshAll();

    setInterval(()=>{ if (!sel?.value) return; loadProgress(sel.value).catch(showError); loadShadow(sel.value).catch(showError); }, 60000);
    if (sel?.value) drawSpark(sel.value);
    window.addEventListener('resize', ()=>{ if (sel?.value) drawSpark(sel.value); });

  }catch(e){ showError(e); }
});
</script>
</body>
</html>
