<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <link rel="icon" href="data:,">
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices…</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">⟳</button>
    </div>
  </header>
<section class="dashboard" id="dashboard" hidden>
  <div class="dash-hero">
    <div>
      <h1>Overview</h1>
     <!-- Level + Progress -->
      <div class="dash-level">Level <span id="growthLevelDash" class="level">-</span></div>
      <div class="progress-lite dash-progress">
        <div class="track"><div id="barFillDash" class="fill"></div></div>
        <div class="pct"><span id="pctTopDash">0</span>%</div>
      </div>

      <!-- KPIs -->
      <div class="dash-kpis">
        <div class="dkpi kpi-water">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#ffd639"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M12,20a6,6,0,0,1-6-6c0-4,6-10.8,6-10.8S18,10,18,14A6,6,0,0,1,12,20Z"></path> <rect width="24" height="24" fill="none"></rect> </g></svg>
          <small>Water</small>
          <b id="dkpi-water">—</b>
        </div>
        <div class="dkpi kpi-ph">
          <svg fill="#ffd639" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#ffd639"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M316.362,73.297c-4.466,0-8.084,3.62-8.084,8.084v30.72h-35.57v-30.72c0-4.465-3.619-8.084-8.084-8.084 c-4.466,0-8.084,3.62-8.084,8.084v81.92c0,4.465,3.618,8.084,8.084,8.084c4.466,0,8.084-3.62,8.084-8.084v-35.032h35.57v35.032 c0,4.465,3.618,8.084,8.084,8.084c4.466,0,8.084-3.62,8.084-8.084v-81.92C324.446,76.916,320.828,73.297,316.362,73.297z"></path> </g> </g> <g> <g> <path d="M238.754,73.297h-43.116c-4.466,0-8.084,3.62-8.084,8.084v38.804v43.116c0,4.465,3.618,8.084,8.084,8.084 c4.466,0,8.084-3.62,8.084-8.084v-35.032h35.032c4.466,0,8.084-3.62,8.084-8.084V81.381 C246.838,76.916,243.219,73.297,238.754,73.297z M230.669,112.101h-26.947V89.465h26.947V112.101z"></path> </g> </g> <g> <g> <path d="M381.036,0H130.964c-4.466,0-8.084,3.62-8.084,8.084v53.895c0,4.465,3.618,8.084,8.084,8.084 c4.466,0,8.084-3.62,8.084-8.084v-45.81h233.903v216.643L300.5,293.187h-89l-72.452-60.376V98.627 c0-4.465-3.618-8.084-8.084-8.084c-4.466,0-8.084,3.62-8.084,8.084v137.971c0,2.399,1.065,4.675,2.908,6.211l74.7,62.25v121.249 c0,4.465,3.619,8.084,8.084,8.084h9.162v69.524c0,4.465,3.618,8.084,8.084,8.084h60.362c4.466,0,8.084-3.62,8.084-8.084v-69.524 h9.162c4.466,0,8.084-3.62,8.084-8.084V305.058l74.7-62.25c1.843-1.536,2.908-3.811,2.908-6.211V8.084 C389.12,3.62,385.502,0,381.036,0z M278.097,495.832h-44.194v-61.44h44.194V495.832z M295.343,418.223h-78.686V309.356h78.686 V418.223z"></path> </g> </g> <g> <g> <path d="M346.543,38.804H165.457c-4.466,0-8.084,3.62-8.084,8.084v150.905c0,4.465,3.619,8.084,8.084,8.084h181.086 c4.466,0,8.084-3.62,8.084-8.084V46.888C354.627,42.424,351.009,38.804,346.543,38.804z M338.459,189.709H173.541V54.973h164.918 V189.709z"></path> </g> </g> <g> <g> <path d="M215.04,215.579c-15.156,0-27.486,12.33-27.486,27.486c0,15.156,12.33,27.486,27.486,27.486 c15.156,0,27.486-12.33,27.486-27.486C242.526,227.909,230.196,215.579,215.04,215.579z M215.04,254.383 c-6.241,0-11.318-5.077-11.318-11.318c0-6.241,5.077-11.318,11.318-11.318c6.241,0,11.318,5.077,11.318,11.318 C226.358,249.306,221.281,254.383,215.04,254.383z"></path> </g> </g> <g> <g> <path d="M296.96,215.579c-15.156,0-27.486,12.33-27.486,27.486c0,15.156,12.33,27.486,27.486,27.486 c15.156,0,27.486-12.33,27.486-27.486C324.446,227.909,312.116,215.579,296.96,215.579z M296.96,254.383 c-6.241,0-11.318-5.077-11.318-11.318c0-6.241,5.077-11.318,11.318-11.318s11.318,5.077,11.318,11.318 C308.278,249.306,303.201,254.383,296.96,254.383z"></path> </g> </g> <g> <g> <path d="M273.246,353.995c-4.466,0-8.084,3.62-8.084,8.084v29.736c0,4.465,3.618,8.084,8.084,8.084 c4.466,0,8.084-3.62,8.084-8.084v-29.736C281.331,357.614,277.712,353.995,273.246,353.995z"></path> </g> </g> <g> <g> <path d="M273.246,323.368c-4.466,0-8.084,3.62-8.084,8.084v8.511c0,4.465,3.618,8.084,8.084,8.084c4.466,0,8.084-3.62,8.084-8.084 v-8.511C281.331,326.988,277.712,323.368,273.246,323.368z"></path> </g> </g> </g></svg>
          <small>pH Level</small>
          <b id="dkpi-ph">—</b>
        </div>
        <div class="dkpi kpi-temp">
          <svg viewBox="0 0 24 24" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" fill="#ffd639" stroke="#ffd639"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><defs><style>.cls-1{fill:none;stroke:#ffd639;stroke-miterlimit:10;stroke-width:1.83px;}</style></defs><circle class="cls-1" cx="11.08" cy="17.5" r="0.92"></circle><path class="cls-1" d="M14.75,14.78V5.58a3.67,3.67,0,0,0-7.33,0v9.2A4.53,4.53,0,0,0,6.5,17.5a4.59,4.59,0,0,0,9.17,0A4.53,4.53,0,0,0,14.75,14.78Z"></path><line class="cls-1" x1="11.08" y1="5.58" x2="11.08" y2="16.58"></line><line class="cls-1" x1="14.75" y1="6.5" x2="17.5" y2="6.5"></line><line class="cls-1" x1="14.75" y1="10.17" x2="17.5" y2="10.17"></line><line class="cls-1" x1="14.75" y1="13.83" x2="17.5" y2="13.83"></line></g></svg>
          <small>Temperature (°C)</small>
          <b id="dkpi-temp">—</b>
        </div>
      </div>
    </div>              <!-- ✅ ปิด div ชั้นใน -->
  </div>       

    <!-- Panels -->
    <div class="dash-panels">
      <div class="dash-card growth">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Growth analytics</h3>
        </div>
        <div class="dash-spark">
          <canvas id="spark" width="800" height="220" aria-label="pH & Temp chart"></canvas>
        </div>
        <div class="legend" style="margin-top:8px;font-size:12px;">
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#16a34a;margin-right:6px;"></span> pH
          &nbsp;&nbsp;
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2563eb;margin-right:6px;"></span> Temp
        </div>
      </div>

      <div class="dash-card alerts">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Critical Alerts</h3>
        </div>
        <ul class="dash-alerts" id="dash-alerts">
          <li><span class="ok"></span> Optimal growth</li>
          <li><span class="warn"></span> Low water level</li>
          <li><span class="bad"></span> pH above normal</li>
        </ul>
      </div>

      <div class="dash-card activity">
        <h3>Activity Overview</h3>
        <div class="dash-activity" id="dash-activity">
          <div class="dash-evt"><div><b>Watering System Adjustment</b><div><small>10:00–11:00</small></div></div><button class="dash-btn">Details</button></div>
          <div class="dash-evt"><div><b>Fertilizer Check</b><div><small>12:00–12:30</small></div></div><small>Completed</small></div>
          <div class="dash-evt"><div><b>Lighting Adjustment</b><div><small>16:00–18:00</small></div></div><small>In Progress</small></div>
        </div>
      </div>
    </div>
  </section>

<script>
/* ========== Config ========== */
const LIFF_ID = '2008085765-YDwJrxy9';
const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

/* ========== DOM helpers ========== */
const $ = (id) => document.getElementById(id);
const barFillDash = $('barFillDash');
const pctTopDash = $('pctTopDash');
const growthLevelDash = $('growthLevelDash');

/* ========== Utils ========== */
function showError(err){ console.error(err); }
function normalizeLevel(lvl){
  if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
  if (typeof lvl === 'string' && /^\d+$/.test(lvl)) { const n = parseInt(lvl,10); return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl; }
  if (String(lvl).toLowerCase().includes('ready')) return '4';
  return String(lvl || '-');
}
function pickUpdated(d){
  if (d?.updatedAtIso) return d.updatedAtIso;
  const u = d?.updatedAt;
  if (!u) return '—';
  if (typeof u === 'string') return u;
  if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds*1000).toISOString();
  return String(u);
}
function getNum(obj, keys){
  const all = Object.keys(obj || {}), canon = s => String(s||'').toLowerCase();
  for (const k of all){ const ck = canon(k); if (keys.some(q => ck.includes(canon(q)))){ const v = Number(obj[k]); if (!Number.isNaN(v)) return v; } }
  for (const k of all){ if (obj[k] && typeof obj[k] === 'object'){ const v = getNum(obj[k], keys); if (typeof v === 'number') return v; } }
  return null;
}

/* ========== LINE Auth ========== */
function stripRedirectUri(){ return location.origin + location.pathname; }
async function ensureLogin(){
  if (liff.isLoggedIn()) return;
  const redirectUri = stripRedirectUri();
  if (liff.isInClient()) liff.login();
  else liff.login({ withLoginOnExternalBrowser:true, redirectUri });
  return new Promise(()=>{});
}
function buildAuthHeaders(){
  const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
  const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
  const h = { 'Content-Type':'application/json' };
  if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
  else if (access) h['x-line-access-token'] = access;
  else throw new Error('No LINE token available');
  return h;
}
async function authedGet(url){
  const r = await fetch(url, { headers: buildAuthHeaders() });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.error) throw new Error(j.error || t);
  return j;
}
async function authedPost(url, body){
  const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
  return j;
}

/* ========== Formatters (DKPI) ========== */
const formatPh   = p => (p==null || Number.isNaN(+p)) ? '—' : `${(+p).toFixed(1)} pH`;
const formatTemp = t => (t==null || Number.isNaN(+t)) ? '—' : `${(+t).toFixed(1)}°C`;
function formatWater(w){
  if (w==null || Number.isNaN(+w)) return '—';
  const n = +w; if (n <= 1) return `${Math.round(n*100)}%`; if (n <= 100) return `${Math.round(n)}%`; return String(n);
}

/* ========== APIs ========== */
async function getProgress(deviceId){
  const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
  const r = await fetch(url, { cache:'no-store' }); const j = await r.json();
  if (!r.ok || j.error) throw new Error(j.error || JSON.stringify(j));
  return j;
}
async function loadProgress(deviceId){
  const data = await getProgress(deviceId);
  const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
  const lvl = normalizeLevel(data.level);
  if (pctTopDash) pctTopDash.textContent = pct!=null ? pct.toFixed(1) : '—';
  if (barFillDash) barFillDash.style.width = pct!=null ? `${pct}%` : '0%';
  if (growthLevelDash) growthLevelDash.textContent = lvl;
}
async function loadShadow(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};
  const ph   = getNum(data, ['soil_ph','pH','ph']);
  const temp = getNum(data, ['temp','temperature','temp_c']);
  updateSeries(deviceId, typeof ph==='number'?ph:null, typeof temp==='number'?temp:null);
  drawSpark(deviceId);
  return { data, ph, temp };
}
async function renderDkpiForDevice(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};
  const water = getNum(data, ['water_level','water','level','wl','water_percent','waterPct']);
  const ph    = getNum(data, ['soil_ph','pH','ph']);
  const temp  = getNum(data, ['temp','temperature','temp_c']);
  $('dkpi-water').textContent = formatWater(water);
  $('dkpi-ph').textContent    = formatPh(ph);
  $('dkpi-temp').textContent  = formatTemp(temp);
  localStorage.setItem('deviceId', deviceId);
}

/* ========== Sparkline (pH & Temp) ========== */
const SERIES_MAX = 120;
function seriesKey(deviceId){ return 'series_' + deviceId; }
function loadSeries(deviceId){ try{ return JSON.parse(localStorage.getItem(seriesKey(deviceId))) || {t:[],ph:[],temp:[]}; }catch{ return {t:[],ph:[],temp:[]}; } }
function saveSeries(deviceId, s){ localStorage.setItem(seriesKey(deviceId), JSON.stringify(s)); }
function updateSeries(deviceId, ph, temp){
  if (!deviceId || (ph==null && temp==null)) return;
  const s = loadSeries(deviceId); const now = Date.now();
  if (s.t.length && now - s.t[s.t.length-1] < 50*1000){
    if (typeof ph==='number') s.ph[s.ph.length-1] = ph;
    if (typeof temp==='number') s.temp[s.temp.length-1] = temp;
  }else{
    s.t.push(now); s.ph.push(typeof ph==='number'?ph:null); s.temp.push(typeof temp==='number'?temp:null);
  }
  while (s.t.length > SERIES_MAX){ s.t.shift(); s.ph.shift(); s.temp.shift(); }
  saveSeries(deviceId, s);
}
function drawSpark(deviceId){
  const c = document.getElementById('spark'); if (!c) return;
  const rect = c.getBoundingClientRect();
  const cssW = Math.max(1, Math.floor(rect.width));
  const cssH = Math.max(1, Math.floor(rect.height));
  const dpr  = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  if (c.width!==cssW*dpr) c.width = cssW*dpr;
  if (c.height!==cssH*dpr) c.height = cssH*dpr;

  const ctx = c.getContext('2d');
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,cssW,cssH);

  const s = loadSeries(deviceId); const n = s.t.length; if (!n) return;
  const pad = {l:40,r:10,t:18,b:24}, iw = cssW-pad.l-pad.r, ih = cssH-pad.t-pad.b;
  const clamp = (v,lo,hi)=>Math.min(hi,Math.max(lo,v));
  const phVals = s.ph.filter(v=>typeof v==='number');
  let phMin = phVals.length?Math.min(...phVals):7, phMax = phVals.length?Math.max(...phVals):7;
  if (phMax===phMin){ phMax+=.1; phMin-=.1; }
  const phPad=(phMax-phMin)*.15+.1; phMin=clamp(phMin-phPad,0,14); phMax=clamp(phMax+phPad,.1,14);
  const tVals = s.temp.filter(v=>typeof v==='number');
  let tMin = tVals.length?Math.min(...tVals):25, tMax = tVals.length?Math.max(...tVals):25;
  if (tMax===tMin){ tMax+=.5; tMin-=.5; }
  const tPad=(tMax-tMin)*.15+.5; tMin=Math.max(0,tMin-tPad); tMax=tMax+tPad;
  const xAt=i=>pad.l+(i/Math.max(1,n-1))*iw, yAt=(v,min,max)=>pad.t+(1-((clamp(v,min,max)-min)/(max-min)))*ih;

  ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.lineWidth=1;
  for(let g=0; g<=4; g++){ const y=pad.t+g*(ih/4); ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+iw,y); ctx.stroke(); }

  const line=(arr,min,max,color)=>{ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); let moved=false;
    for(let i=0;i<n;i++){ const v=arr[i]; if(typeof v!=='number') continue; const x=xAt(i), y=yAt(v,min,max); if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y); }
    if(moved) ctx.stroke();
  };
  line(s.ph, phMin, phMax, '#34d399');   // pH
  line(s.temp, tMin, tMax, '#60a5fa');   // Temp

  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
  ctx.textAlign='left';  ctx.fillText(`pH ${phMin.toFixed(1)}–${phMax.toFixed(1)}`, pad.l, pad.t-4);
  ctx.textAlign='right'; ctx.fillText(`Temp ${Math.round(tMin)}–${Math.round(tMax)}°C`, pad.l+iw, pad.t-4);
}

/* ========== Boot ========== */
window.addEventListener('DOMContentLoaded', async () => {
  try{
    await liff.init({ liffId: LIFF_ID });
    await ensureLogin();

    const qs = new URLSearchParams(location.search);
    if (qs.get('code') || qs.get('liffRedirectUri')) history.replaceState({}, '', stripRedirectUri());

    const idToken = liff.getIDToken(); const accessToken = liff.getAccessToken();
    if (idToken) sessionStorage.setItem('line_id_token', idToken);
    if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

    const sel = $('deviceSelect');

    // devices
    let devices = [];
    try{ const resp = await authedGet('/api/devices'); devices = Array.isArray(resp?.devices)?resp.devices:[]; }
    catch(e){ showError(e); }

    if (sel){
      sel.innerHTML='';
      if (devices.length===0){
        const op=document.createElement('option'); op.value=''; op.textContent='No device'; sel.appendChild(op);
      }else{
        devices.forEach(d=>{ const op=document.createElement('option'); op.value=d.deviceId; op.textContent=d.name||d.deviceId; sel.appendChild(op); });
        const saved = localStorage.getItem('deviceId'); if (saved && [...sel.options].some(o=>o.value===saved)) sel.value=saved;
      }
    }

    async function refreshAll(){
      if (!sel?.value) return;
      await Promise.all([ loadShadow(sel.value), loadProgress(sel.value), renderDkpiForDevice(sel.value) ]);
      $('dashboard').hidden = false;
    }

    $('refreshBtn') && ($('refreshBtn').onclick = refreshAll);
    sel && (sel.onchange = async ()=>{ localStorage.setItem('deviceId', sel.value||''); await refreshAll(); });

    await refreshAll();

    setInterval(()=>{ if (!sel?.value) return; loadProgress(sel.value).catch(showError); loadShadow(sel.value).catch(showError); }, 60000);
    if (sel?.value) drawSpark(sel.value);
    window.addEventListener('resize', ()=>{ if (sel?.value) drawSpark(sel.value); });

  }catch(e){ showError(e); }
});
</script>
</body>
</html>
