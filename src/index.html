<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LIFF + NexIIoT</title>
  <link rel="icon" href="data:,"><!-- กัน 404 /favicon.ico -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/graphql-ws/umd/graphql-ws.min.js"></script>
  <style>
    body{font-family:system-ui,sans-serif;padding:16px}
    .row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input,button{padding:8px 10px;border-radius:8px;border:1px solid #ccc}
    button.primary{background:#06c755;color:#fff;border:none}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
    table{border-collapse:collapse;width:100%}
    td{border-bottom:1px solid #eee;padding:6px 4px}
    pre{background:#f6f6f6;padding:10px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <h2>LIFF + NexIIoT GraphQL</h2>
  <div id="me">กำลังโหลด LIFF…</div>

  <div class="card">
    <b>เข้าสู่ระบบ NexIIoT</b>
    <div class="row">
      <input id="u" placeholder="username (email)"/>
      <input id="p" placeholder="password" type="password"/>
      <button id="loginBtn" class="primary">Login</button>
    </div>
    <div id="loginStatus" style="color:#666">รอกด Login</div>
  </div>

  <div class="card" id="dash" style="display:none">
    <div class="row">
      <div><b>Device:</b> <span id="devId"></span></div>
      <div id="lastUpdate" style="color:#777">—</div>
    </div>
    <table id="tbl"><tbody></tbody></table>
    <div class="row">
      <button id="refreshBtn">Refresh</button>
      <button id="onBtn"  class="primary">relay1 ON</button>
      <button id="offBtn">relay1 OFF</button>
    </div>
  </div>

  <div class="card">
    <b>Raw output</b>
    <pre id="out">—</pre>
  </div>

<script>
(async () => {
  // ==== ตั้งค่า ====
  const LIFF_ID   = 'YOUR_LIFF_ID';          // <-- ใส่ของจริง (เช่น 2008085765-XXXXXX)
  const API_BASE  = '/api';                   // เรียกฟังก์ชันบนโดเมนเดียวกัน
  const NX_GQL_WS = 'wss://gqlv2.nexiiot.io/graphql';
  const DEVICE_ID = 'device-1';

  // ==== จับ DOM ให้ครบ (แก้ onBtn is not defined) ====
  const $ = (id) => document.getElementById(id);
  const me = $('me'), u = $('u'), p = $('p'), loginBtn = $('loginBtn');
  const out = $('out'), dash = $('dash'), devId = $('devId'), lastUpdate = $('lastUpdate');
  const refreshBtn = $('refreshBtn'), onBtn = $('onBtn'), offBtn = $('offBtn');
  const tbody = document.querySelector('#tbl tbody');

  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  const prof = await liff.getProfile();
  me.textContent = `สวัสดี, ${prof.displayName}`;

  // fields ที่คุณให้มา
  const FIELDS = [
    "Soil_moisture","Soil_temperature","Soil_EC","Soil_pH","Soil_N","Soil_P","Soil_K",
    "EC","EC_temp","pH","pH_temp","Temp_out","Humi_out","Light_out",
    "Wind_speed","Wind_direction","Temperature_in","Humidity_in","Light_in","CO2",
    "relay1","relay2"
  ];

  function show(o){ out.textContent = typeof o === 'string' ? o : JSON.stringify(o, null, 2); }

  async function postJSON(url, payload){
    const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const t = await r.text(); let j; try{ j=JSON.parse(t);}catch{ throw new Error(`HTTP ${r.status}: ${t.slice(0,120)}`); }
    if(!r.ok || j.error) throw new Error(typeof j==='string'?j:JSON.stringify(j));
    return j;
  }

  // token state
  let accessToken=null, refreshToken=null, expAt=0;
  async function ensureToken(){
    if(!refreshToken || Date.now()<expAt) return;
    const j = await postJSON(`${API_BASE}/auth/refresh`, { refresh_token: refreshToken });
    accessToken=j.access_token; refreshToken=j.refresh_token||refreshToken; expAt=Date.now()+(j.expires_in-30)*1000;
  }
  async function gql(query, variables){
    await ensureToken();
    return postJSON(`${API_BASE}/gql`, { query, variables, access_token: accessToken });
  }

  // GraphQL docs
  const Q_SHADOW = `query($deviceid:String!){ shadow(deviceid:$deviceid){deviceid data rev modified} }`;
  const M_WRITE  = `mutation($deviceid:String!,$data:JSON!){ writeShadow(deviceid:$deviceid,data:$data){deviceid data rev modified} }`;
  const SUB_UPD  = `subscription($deviceid:String!){ shadowUpdated(deviceid:$deviceid){deviceid data rev modified} }`;

  function renderData(data){
    tbody.innerHTML=''; if(!data) return;
    for(const k of FIELDS){
      if(Object.prototype.hasOwnProperty.call(data,k)){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${k}</td><td>${String(data[k])}</td>`;
        tbody.appendChild(tr);
      }
    }
  }
  async function refreshShadow(){
    try{
      const d = await gql(Q_SHADOW,{deviceid:DEVICE_ID});
      const s = d.shadow||{};
      devId.textContent = s.deviceid||DEVICE_ID;
      renderData(s.data);
      lastUpdate.textContent = 'updated: '+(s.modified||new Date().toISOString());
      dash.style.display='block';
      show(d);
    }catch(e){ show('ERR '+e.message); }
  }
  async function setRelay1(v){
    try{ await gql(M_WRITE,{deviceid:DEVICE_ID,data:{relay1:v}}); await refreshShadow(); alert('relay1 '+v); }
    catch(e){ alert('command failed: '+e.message); }
  }

  loginBtn.onclick = async () => {
    try{
      loginStatus.textContent='logging in…';
      const j = await postJSON(`${API_BASE}/auth/login`, { username:u.value.trim(), password:p.value });
      accessToken=j.access_token; refreshToken=j.refresh_token; expAt=Date.now()+(j.expires_in-30)*1000;
      loginStatus.textContent='login OK';
      await refreshShadow();

      const client = graphqlWs.createClient({
        url: NX_GQL_WS,
        connectionParams: { headers: { Authorization: `Bearer ${accessToken}` } }
      });
      client.subscribe(
        { query: SUB_UPD, variables: { deviceid: DEVICE_ID } },
        {
          next: (msg)=>{ const s=msg?.data?.shadowUpdated; if(s?.data){ renderData(s.data); lastUpdate.textContent='updated: '+(s.modified||new Date().toISOString()); show(msg.data); } },
          error: (err)=>console.error('subscription error',err),
          complete: ()=>console.log('subscription complete')
        }
      );
    }catch(e){ loginStatus.textContent='login failed: '+e.message; show(e.message); }
  };

  refreshBtn.onclick = refreshShadow;
  onBtn.onclick  = () => setRelay1('on');
  offBtn.onclick = () => setRelay1('off');
})();
</script>
</body>
</html>
