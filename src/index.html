<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FINH • Growth Monitor</title>

  <!-- ธีม FINH (เขียว–น้ำเงิน) -->
  <link rel="stylesheet" href="src/theme.css">

  <!-- LINE LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="bar wrap">
      <img src="/finh_logo.png" alt="FINH" class="logo" height="28" />
      <div class="title">Growth Monitor</div>
      <div class="spacer"></div>
      <div class="pill" id="userPill">
        <img id="userAvatar" class="avatar" alt="avatar" />
        <span id="userName">—</span>
        <button id="copyBtn" class="linkish" title="Copy userId">Copy ID</button>
        <button id="logoutBtn" class="linkish">Logout</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap">
    <!-- Controls -->
    <section class="card">
      <div class="row">
        <label>Device:
          <select id="deviceSelect"></select>
        </label>
        <button id="refreshBtn" class="primary">Refresh</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <!-- Progress -->
    <section class="card">
      <div class="row" style="align-items:flex-end">
        <div style="flex:1">
          <div class="muted">Progress</div>
          <div class="bar"><span id="growthBar"></span></div>
          <div class="row" style="justify-content:space-between">
            <div class="big"><span id="growthPct">—</span>%</div>
            <div class="chips">
              <span class="chip info">Level: <b id="growthLevel">—</b></span>
              <span class="chip" id="growthGoodChip">Status: <b id="growthGoodTxt">—</b></span>
            </div>
          </div>
        </div>
      </div>
      <div class="row muted">
        <div>Updated: <span id="growthUpdated">—</span></div>
      </div>
    </section>

    <!-- Sensors quick view -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="muted">Sensors</div>
        <div class="muted" id="shadowMeta">—</div>
      </div>
      <div class="grid" id="sensorsGrid"></div>
    </section>

    <!-- Debug -->
    <section class="card">
      <details class="debug" open>
        <summary>Debug shadow JSON</summary>
        <pre id="out">—</pre>
      </details>
    </section>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const LIFF_ID = '2008085765-YDwJrxy9';
    const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

    const $ = (id) => document.getElementById(id);
    const out = $('out');
    const sensorsGrid = $('sensorsGrid');
    const shadowMeta = $('shadowMeta');

    const growthBar = $('growthBar'), growthPct = $('growthPct'),
          growthLevel = $('growthLevel'), growthUpdated = $('growthUpdated'),
          growthGoodChip = $('growthGoodChip'), growthGoodTxt = $('growthGoodTxt');

    const statusEl = $('status');
    const sel = $('deviceSelect');

    const showError = (err) => {
      console.error(err);
      const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
      out.textContent = `ERROR: ${msg}`;
      statusEl.textContent = 'Failed';
    };

    try {
      // Init & login
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login({ scope: ['openid','profile','email'], prompt: 'consent' });
        return;
      }

      // ถ้ากลับมาพร้อม ?code=… ให้ล้าง query ออกกัน error/เรียกซ้ำ
      const qs = new URLSearchParams(location.search);
      if (qs.get('code')) {
        const redirectUri = qs.get('liffRedirectUri')
          ? decodeURIComponent(qs.get('liffRedirectUri'))
          : (location.origin + location.pathname);
        history.replaceState({}, '', redirectUri);
      }

      // เก็บ token จาก LIFF เผื่อเรียก backend /api/*
      const idToken = liff.getIDToken();
      const accessToken = liff.getAccessToken();
      if (idToken) sessionStorage.setItem('line_id_token', idToken);
      if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

      // Render user
      async function renderUser(){
        const profile = await liff.getProfile();
        const decoded = liff.getDecodedIDToken();
        $('userName').textContent = profile.displayName || '—';
        $('userAvatar').src = profile.pictureUrl || '';
        $('userAvatar').alt = profile.displayName || 'avatar';

        $('copyBtn').onclick = async () => {
          try { await navigator.clipboard.writeText(profile.userId || ''); } catch {}
        };
        $('logoutBtn').onclick = () => { liff.logout(); location.reload(); };
        // Tooltip userId
        $('userPill').title = `userId: ${profile.userId || '-'}` + (decoded?.email ? ` • email: ${decoded.email}` : '');
      }
      await renderUser();

      // Auth headers for /api/*
      function buildAuthHeaders() {
        const storedIdToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
        const storedAccess  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
        const h = { 'Content-Type': 'application/json' };
        if (storedIdToken && storedIdToken.includes('.')) {
          h['x-line-id-token'] = storedIdToken;
        } else if (storedAccess) {
          h['x-line-access-token'] = storedAccess;
        } else {
          throw new Error('No LINE token available. Please login again.');
        }
        return h;
      }
      async function authedGet(url) {
        const r = await fetch(url, { headers: buildAuthHeaders(), cache: 'no-store' });
        const t = await r.text(); let j; try { j = JSON.parse(t); } catch { throw new Error(`HTTP ${r.status}: ${t}`); }
        if (!r.ok || j.error) throw new Error(j.error || t);
        return j;
      }
      async function authedPost(url, body) {
        const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
        const t = await r.text(); let j; try { j = JSON.parse(t); } catch { throw new Error(`HTTP ${r.status}: ${t}`); }
        if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
        return j;
      }

      // Load device list
      const { devices } = await authedGet('/api/devices');
      devices.forEach(d => {
        const op = document.createElement('option');
        op.value = d.deviceId;
        op.textContent = d.name || d.deviceId;
        sel.appendChild(op);
      });
      const saved = localStorage.getItem('deviceId');
      if (saved && [...sel.options].some(o => o.value === saved)) sel.value = saved;

      sel.onchange = async () => {
        localStorage.setItem('deviceId', sel.value);
        await refreshShadow();
        await loadGrowth();
      };

      // ===== Shadow (debug + sensor quick view) =====
      const Q_SHADOW = `query($deviceid:String!){
        shadow(deviceid:$deviceid){ deviceid rev modified data }
      }`;

      function kvListFromShadow(shadowData) {
        // คืนรายการ key/value ที่เป็นตัวเลขก่อน 4–8 ตัว
        let obj = shadowData;
        if (typeof obj === 'string') {
          try { obj = JSON.parse(obj); } catch { return []; }
        }
        const out = [];
        const pushNum = (k, v) => {
          const num = (typeof v === 'number') ? v : Number(v);
          if (!Number.isNaN(num)) out.push([k, num]);
        };
        const walk = (o, pref = '') => {
          if (!o || typeof o !== 'object') return;
          for (const k of Object.keys(o)) {
            const v = o[k];
            const key = pref ? `${pref}.${k}` : k;
            if (v && typeof v === 'object' && !Array.isArray(v)) walk(v, key);
            else pushNum(key, v);
          }
        };
        if (obj && typeof obj === 'object') walk(obj);
        return out.slice(0, 8);
      }

      function renderSensors(pairs) {
        sensorsGrid.innerHTML = '';
        if (!pairs.length) {
          sensorsGrid.innerHTML = '<div class="muted">No numeric fields</div>';
          return;
        }
        for (const [k, v] of pairs) {
          const box = document.createElement('div');
          box.className = 'sensor';
          box.innerHTML = `
            <div class="label">${k}</div>
            <div class="val">${v}</div>
          `;
          sensorsGrid.appendChild(box);
        }
      }

      async function refreshShadow() {
        try {
          statusEl.textContent = 'Loading…';
          const r = await authedPost('/api/gql', { query: Q_SHADOW, variables: { deviceid: sel.value } });
          out.textContent = JSON.stringify(r.data, null, 2);

          const s = r?.data?.shadow;
          const modified = s?.modified ? new Date(s.modified).toISOString() : '—';
          shadowMeta.textContent = `deviceid=${s?.deviceid || '—'} • rev=${s?.rev ?? '—'} • modified=${modified}`;

          const pairs = kvListFromShadow(s?.data);
          renderSensors(pairs);

          statusEl.textContent = 'Updated: ' + new Date().toISOString();
        } catch (e) { showError(e); }
      }

      // ===== Progress (%/Level/Status) =====
      function normalizeLevel(lvl) {
        if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
        if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
          const n = parseInt(lvl, 10);
          return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
        }
        return String(lvl || '—');
      }
      function pickUpdated(data) {
        if (data.updatedAtIso) return data.updatedAtIso;
        const u = data.updatedAt;
        if (!u) return '—';
        if (typeof u === 'string') return u;
        if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
        return String(u);
      }
      function setStatusChip(ok) {
        growthGoodTxt.textContent = ok ? 'OK' : 'NOT OK';
        growthGoodChip.className = 'chip ' + (ok ? 'ok' : 'bad');
      }

      async function loadGrowth() {
        try {
          const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(sel.value)}`;
          const r = await fetch(url, { cache: 'no-store' });
          const data = await r.json();
          if (!r.ok || data.error) throw new Error(data.error || JSON.stringify(data));

          const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
          const lvl = normalizeLevel(data.level);
          const good = ('Status' in data) ? !!data.Status : !!data.goodNow;
          const updated = pickUpdated(data);

          growthPct.textContent = pct != null ? pct.toFixed(1) : '—';
          growthBar.style.width = pct != null ? `${pct}%` : '0%';
          growthLevel.textContent = lvl;
          setStatusChip(good);
          growthUpdated.textContent = updated;
        } catch (e) {
          growthPct.textContent = '—';
          growthBar.style.width = '0%';
          growthLevel.textContent = '—';
          setStatusChip(false);
          growthUpdated.textContent = '—';
          showError(e);
        }
      }

      $('refreshBtn').onclick = async () => { await refreshShadow(); await loadGrowth(); };

      // First load
      await refreshShadow();
      await loadGrowth();
      setInterval(loadGrowth, 60000);
    } catch (e) {
      showError(e);
    }
  });
  </script>
</body>
</html>
