<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <!-- กันเบราว์เซอร์ยิง /favicon.ico แล้ว 404 -->
  <link rel="icon" href="data:,">

  <!-- ธีมเดิมของคุณ -->
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- UI เพิ่มเติมเล็กน้อย -->
  <style>
    .topbar{
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg,#4caf67 0%,#7ed07b 100%);
      color:#fff;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .topbar .brand img{height:28px; display:block}
    .topbar .right{display:flex; align-items:center; gap:8px}
    .topbar select{
      appearance:none; border:0; border-radius:999px; padding:8px 12px;
      background:#ffffffdd; color:#0f172a; font-weight:600;
      max-width: 60vw;
    }
    .icon-btn{
      border:0; background:#ffffffcc; border-radius:999px; padding:8px 10px;
      line-height:1; cursor:pointer;
    }

    .container{max-width:460px; margin:0 auto; padding:0 12px 40px}
    .hero{
      display:flex; align-items:center; justify-content:center;
      margin:18px auto 6px; width:96px; height:96px; border-radius:999px;
      background: radial-gradient(ellipse at center, #ffffff 0%, #e7ffe9 100%);
      box-shadow: 0 2px 12px rgba(16, 185, 129, .25) inset, 0 8px 20px rgba(16,24,40,.06);
    }
    .hero img{width:68px; height:68px; object-fit:contain}
    .section-title{ text-align:center; font-weight:800; color:#155e2d; margin-top:6px }
    .subtle{ text-align:center; color:#5b8a6a; font-size:12px }

    /* ปรับขนาดกราฟเล็กลงได้ที่นี่ */
    .progress .bar{ height: 8px; }       /* เดิมในธีมอาจ 10–12px */
    .progress .pct{ font-size: 12px; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <!-- ใส่โลโก้ FINH ของคุณ -->
      <img src="/finh_logo.png" alt="FINH">
    </div>
    <div class="right">
      <!-- ใช้ id เดิมเพื่อไม่กระทบ JS/Backend -->
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices…</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">⟳</button>
    </div>
  </header>

  <!-- เนื้อหา -->
  <div id="app" class="container">
    <!-- ไอคอนตรงกลาง -->
    <div class="hero"><img src="/organic.png" alt="organic"></div>
    <div class="section-title">Peak Protein</div>
    <div class="subtle">
      Level <span id="growthLevel">—</span> • <span id="growthPctTop">—</span>%
    </div>

    <!-- การ์ดแสดง %/สถานะ -->
    <div class="card" id="growthCard" style="margin-top:12px">
      <div class="row">
        <div class="progress flex-1">
          <div class="bar"><span id="growthBar" style="width:0%"></span></div>
          <div class="pct"><span id="growthPctInline">—</span>%</div>
        </div>
      </div>
      <div class="row muted">
        <div>Status: <span id="growthGood">—</span></div>
        <div>Updated: <span id="growthUpdated">—</span></div>
      </div>
    </div>

    <!-- สถานะเรียกข้อมูล + debug -->
    <div class="muted" id="status" style="margin:8px 4px 0 4px; display:block"></div>
    <pre id="out" class="log" style="margin-top:12px">—</pre>
  </div>

  <script>
  // ====== ค่าคงเดิม (ไม่แตะ Backend/Firebase) ======
  const LIFF_ID = '2008085765-YDwJrxy9';
  const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

  const $ = (id) => document.getElementById(id);
  const root = document.getElementById('app') || document.body;

  const showError = (err) => {
    console.error(err);
    const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
    root.insertAdjacentHTML('beforeend',
      `<pre class="log" style="background:#0b1020;color:#cbd5e1">ERROR: ${msg}</pre>`);
  };

  function buildAuthHeaders() {
    const storedIdToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
    const storedAccess  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
    const h = { 'Content-Type': 'application/json' };
    if (storedIdToken && storedIdToken.includes('.')) {
      h['x-line-id-token'] = storedIdToken;
    } else if (storedAccess) {
      h['x-line-access-token'] = storedAccess;
    } else {
      throw new Error('No LINE token available. Please login again.');
    }
    return h;
  }

  async function authedGet(url) {
    const r = await fetch(url, { headers: buildAuthHeaders() });
    const t = await r.text(); let j;
    try { j = JSON.parse(t); } catch { throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.error) throw new Error(j.error || t);
    return j;
  }

  async function authedPost(url, body) {
    const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
    const t = await r.text(); let j;
    try { j = JSON.parse(t); } catch { throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
    return j;
  }

  function normalizeLevel(lvl) {
    if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
    if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
      const n = parseInt(lvl, 10);
      return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
    }
    return String(lvl || '—');
  }

  function pickUpdated(data) {
    if (data.updatedAtIso) return data.updatedAtIso;
    const u = data.updatedAt;
    if (!u) return '—';
    if (typeof u === 'string') return u;
    if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
    return String(u);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login({ scope: ['openid','profile','email'], prompt: 'consent' }); return; }

      // ล้าง ?code=
      const qs = new URLSearchParams(location.search);
      if (qs.get('code')) {
        const redirectUri = qs.get('liffRedirectUri')
          ? decodeURIComponent(qs.get('liffRedirectUri'))
          : (location.origin + location.pathname);
        history.replaceState({}, '', redirectUri);
      }

      // cache tokens
      const idToken = liff.getIDToken();
      const accessToken = liff.getAccessToken();
      if (idToken) sessionStorage.setItem('line_id_token', idToken);
      if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

      const sel = $('deviceSelect'), out = $('out'), statusEl = $('status');
      const growthBar = $('growthBar'),
            growthPctTop = $('growthPctTop'),
            growthPctInline = $('growthPctInline'),
            growthLevel = $('growthLevel'),
            growthGood = $('growthGood'),
            growthUpdated = $('growthUpdated');

      // ----- โหลดอุปกรณ์ (กัน error เมื่อ backend ล่ม) -----
      let devices = [];
      try {
        const resp = await authedGet('/api/devices');
        devices = Array.isArray(resp?.devices) ? resp.devices : [];
      } catch (e) {
        devices = [];
        showError(e);
      }

      sel.innerHTML = '';
      if (devices.length === 0) {
        const op = document.createElement('option');
        op.value = ''; op.textContent = 'No device';
        sel.appendChild(op);
      } else {
        devices.forEach(d => {
          const op = document.createElement('option');
          op.value = d.deviceId;
          op.textContent = d.name || d.deviceId;
          sel.appendChild(op);
        });
        const saved = localStorage.getItem('deviceId');
        if (saved && [...sel.options].some(o => o.value === saved)) sel.value = saved;
      }

      sel.onchange = async () => {
        localStorage.setItem('deviceId', sel.value || '');
        await refresh();
        await loadGrowth();
      };
      $('refreshBtn').onclick = async () => { await refresh(); await loadGrowth(); };

      // ----- Debug GraphQL shadow -----
      const Q_SHADOW = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid rev modified data } }';
      async function refresh() {
        if (!sel.value) { statusEl.textContent = 'Select a device first'; return; }
        try {
          statusEl.textContent = 'Loading…';
          const r = await authedPost('/api/gql', { query: Q_SHADOW, variables: { deviceid: sel.value } });
          out.textContent = JSON.stringify(r.data, null, 2);
          statusEl.textContent = 'Updated: ' + new Date().toISOString();
        } catch (e) { statusEl.textContent = 'Failed'; showError(e); }
      }

      // ----- โหลด %/Level -----
      async function loadGrowth() {
        if (!sel.value) { return; }
        try {
          const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(sel.value)}`;
          const r = await fetch(url, { cache: 'no-store' });
          const data = await r.json();
          if (!r.ok || data.error) throw new Error(data.error || JSON.stringify(data));

          const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
          const lvl = normalizeLevel(data.level);
          const good = ('Status' in data) ? !!data.Status : !!data.goodNow;
          const updated = pickUpdated(data);

          const pctText = pct != null ? pct.toFixed(1) : '—';
          growthPctTop.textContent = pctText;
          growthPctInline.textContent = pctText;
          growthBar.style.width = pct != null ? `${pct}%` : '0%';
          growthLevel.textContent = lvl;
          growthGood.textContent = good ? 'OK' : 'NOT OK';
          growthGood.className = good ? 'status-ok' : 'status-bad';
          growthUpdated.textContent = updated;
        } catch (e) {
          growthPctTop.textContent = growthPctInline.textContent = '—';
          growthBar.style.width = '0%';
          growthLevel.textContent = '—';
          growthGood.textContent = '—';
          growthGood.className = '';
          growthUpdated.textContent = '—';
          showError(e);
        }
      }

      // เริ่มต้น
      await refresh();
      await loadGrowth();
      setInterval(loadGrowth, 60000);

    } catch (e) { showError(e); }
  });
  </script>
</body>
</html>
