<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <!-- ‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏¥‡∏á /favicon.ico ‡πÅ‡∏•‡πâ‡∏ß 404 -->
  <link rel="icon" href="data:,">

  <!-- ‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ï‡∏£‡∏á‡∏†‡∏≤‡∏û -->
  <style>
    :root{
      --bar-h: 8px;               /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏ñ‡∏ö progress ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
      --card-radius: 16px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans Thai', sans-serif;
      color:#11472d;
      min-height:100vh;
      background: linear-gradient(180deg,#4caf67 0%, #6dcf7b 45%, #b5e39f 100%) fixed;
    }

    /* Top bar */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      color:#fff;
      background: transparent;
    }
    .brand img{ height:90px; display:block; }
    .topbar .right{ display:flex; gap:8px; align-items:center; }
    .topbar select{
      appearance:none; border:0; outline:0;
      border-radius:999px; padding:8px 12px;
      background:#ffffffdd; color:#0f172a; font-weight:700;
      max-width:62vw;
    }
    .icon-btn{
      border:0; background:#ffffffcc; border-radius:999px; padding:8px 10px;
      line-height:1; cursor:pointer;
    }

    .wrap{ max-width:420px; margin:0 auto; padding: 6px 16px 40px; }

    /* Hero (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Organic ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) */
    .hero{
      width:104px; height:104px; margin:18px auto 10px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(ellipse at center, #fff 0%, #e7ffe9 100%);
      box-shadow: 0 2px 14px rgba(16, 185, 129, .25) inset, 0 8px 22px rgba(16,24,40,.06);
    }
    .hero img{ width:74px; height:74px; object-fit:contain; }

    .center{ text-align:center; color:#ffffff; }
    .title{ font-size:20px; font-weight:800; }
    .sub{ opacity:.9; font-weight:600; }

    /* Progress ‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏û */
    .progress-lite{
      display:flex; align-items:center; gap:10px;
      justify-content:center; margin:12px auto 0; width:88%;
    }
    .track{
      flex:1; height:var(--bar-h);
      background:#ffffff70; border-radius:999px; overflow:hidden;
    }
    .fill{
      height:100%; width:0%;
      background:#2ecc71; border-radius:999px;
      transition: width .35s ease;
    }
    .pct{ color:#fff; font-weight:800; }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î Status */
    .card{
      background:#fff; border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      border:1px solid #e6f3e8;
      margin-top:18px; padding:12px 14px;
    }
    .card h3{
      margin:6px 8px 8px; font-size:14px; color:#215b3a; letter-spacing:.2px;
    }
    .metrics{ list-style:none; padding:0; margin:0; }
    .metrics li{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 10px;
      border-top:1px solid #edf3ee;
    }
    .metrics li:first-child{ border-top:0; }
    .metric-left{ display:flex; align-items:center; gap:10px; color:#215b3a; }
    .ic{
      width:28px; height:28px; display:grid; place-items:center;
      border-radius:10px; background:#e8f7ec; color:#1d8b4d;
    }
    .val{ font-weight:700; color:#173c28; }

    /* CTA ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    .cta{
      margin:18px auto 0; width:100%;
      background:#e7efe8; color:#5d7468;
      font-weight:800; font-size:16px;
      border:0; border-radius:18px; padding:16px 12px;
    }
    .cta.ready{ background:#1bb266; color:#fff; box-shadow:0 6px 18px rgba(27,178,102,.35); }

    /* Debug log (‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) */
    #out{ display:none; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices‚Ä¶</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">‚ü≥</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero + Title -->
    <div class="hero"><img src="./assets/organic.png" alt="organic"></div>
    <div class="center">
      <div class="title">Peak Protein</div>
      <div class="sub">Level <span id="growthLevel">-</span></div>
    </div>

    <!-- Progress -->
    <div class="progress-lite">
      <div class="track"><div id="barFill" class="fill"></div></div>
      <div class="pct"><span id="pctTop">0</span>%</div>
    </div>

    <!-- Status Card -->
    <section class="card" id="statusCard">
      <h3>Status</h3>
      <ul class="metrics">
        <li>
          <div class="metric-left">
            <div class="ic">üçÉ</div><div>Chlorophyll</div>
          </div>
          <div class="val" id="mChl">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üíß</div><div>Soil pH</div>
          </div>
          <div class="val" id="mPh">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üå°Ô∏è</div><div>Temp</div>
          </div>
          <div class="val" id="mTemp">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">‚ö°</div><div>Soil EC</div>
          </div>
          <div class="val" id="mEc">‚Äî</div>
        </li>
      </ul>
    </section>

    <!-- Big CTA -->
    <button id="ctaState" class="cta">Not Ready Yet</button>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î + debug -->
    <div id="status" style="color:#fff; margin:10px 4px;"></div>
    <pre id="out" class="log">‚Äî</pre>
  </main>

  <script>
  // ======== ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ Backend/Firebase) =========
  const LIFF_ID = '2008085765-YDwJrxy9';
  const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

  const $ = (id) => document.getElementById(id);
  const statusEl = $('status');
  const out = $('out');

  const barFill = $('barFill');
  const pctTop = $('pctTop');
  const growthLevel = $('growthLevel');
  const cta = $('ctaState');

  const metricEls = { chl: $('mChl'), ph: $('mPh'), temp: $('mTemp'), ec: $('mEc') };

  function showError(err){
    console.error(err);
    const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
    statusEl.textContent = 'Error: ' + msg;
    out.style.display = 'block';
    out.textContent = msg;
  }

  function buildAuthHeaders(){
    const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
    const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
    const h = { 'Content-Type': 'application/json' };
    if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
    else if (access) h['x-line-access-token'] = access;
    else throw new Error('No LINE token available');
    return h;
  }
  async function authedGet(url){
    const r = await fetch(url, { headers: buildAuthHeaders() });
    const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.error) throw new Error(j.error || t);
    return j;
  }
  async function authedPost(url, body){
    const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
    const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
    return j;
  }

  function normalizeLevel(lvl){
    if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
    if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
      const n = parseInt(lvl, 10);
      return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
    }
    if (String(lvl).toLowerCase().includes('ready')) return '4';
    return String(lvl || '-');
  }

  function pickUpdated(d){
    if (d.updatedAtIso) return d.updatedAtIso;
    const u = d.updatedAt;
    if (!u) return '‚Äî';
    if (typeof u === 'string') return u;
    if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
    return String(u);
  }

  // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å shadow ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)
  function getNum(obj, keys){
    const all = Object.keys(obj || {});
    // ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÅ‡∏ö‡∏ö contains (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà / _ .)
    const canon = s => String(s||'').toLowerCase();
    for (const k of all){
      const ck = canon(k);
      if (keys.some(q => ck.includes(canon(q)))){
        const v = Number(obj[k]);
        if (!Number.isNaN(v)) return v;
      }
    }
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö data ‡∏ã‡πâ‡∏≠‡∏ô
    for (const k of all){
      if (obj[k] && typeof obj[k] === 'object'){
        const v = getNum(obj[k], keys);
        if (typeof v === 'number') return v;
      }
    }
    return null;
  }

  function setMetric(el, val, suffix=''){
    el.textContent = (val==null || Number.isNaN(val)) ? '‚Äî' : (suffix ? `${val}${suffix}` : String(val));
  }

  async function loadShadow(deviceId){
    const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid rev modified data } }';
    const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
    out.textContent = JSON.stringify(r.data, null, 2);   // debug ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ)
    const data = r?.data?.shadow?.data || {};

    // ‡πÄ‡∏î‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const chl  = getNum(data, ['chloro','chlorophyll','par','ndvi','leaf']);
    const ph   = getNum(data, ['soil_ph','pH','ph']);
    const temp = getNum(data, ['temp','temperature']);
    const ec   = getNum(data, ['soil_ec','ec','conductivity']);

    setMetric(metricEls.chl,  chl!=null ? +chl.toFixed(1) : null);
    setMetric(metricEls.ph,   ph!=null ? +ph.toFixed(2) : null);
    setMetric(metricEls.temp, temp!=null ? +temp.toFixed(1) : null, '¬∞C');
    setMetric(metricEls.ec,   ec!=null ? +ec.toFixed(3) : null);
  }

  async function loadProgress(deviceId){
    const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
    const r = await fetch(url, { cache:'no-store' });
    const data = await r.json();
    if (!r.ok || data.error) throw new Error(data.error || JSON.stringify(data));

    const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
    const lvl = normalizeLevel(data.level);
    const good = ('Status' in data) ? !!data.Status : !!data.goodNow;
    const updated = pickUpdated(data);

    pctTop.textContent = pct!=null ? pct.toFixed(1) : '‚Äî';
    barFill.style.width = pct!=null ? `${pct}%` : '0%';
    growthLevel.textContent = lvl;

    cta.textContent = good ? 'Ready!' : 'Not Ready Yet';
    cta.classList.toggle('ready', good);

    statusEl.textContent = `Updated: ${updated}`;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    try{
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()){
        liff.login({ scope:['openid','profile','email'], prompt:'consent' });
        return;
      }

      // clear ?code
      const qs = new URLSearchParams(location.search);
      if (qs.get('code')){
        const redirectUri = qs.get('liffRedirectUri')
          ? decodeURIComponent(qs.get('liffRedirectUri'))
          : (location.origin + location.pathname);
        history.replaceState({}, '', redirectUri);
      }

      // cache token
      const idToken = liff.getIDToken();
      const accessToken = liff.getAccessToken();
      if (idToken) sessionStorage.setItem('line_id_token', idToken);
      if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

      const sel = $('deviceSelect');

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      let devices = [];
      try{
        const resp = await authedGet('/api/devices');
        devices = Array.isArray(resp?.devices) ? resp.devices : [];
      }catch(e){ showError(e); }

      sel.innerHTML = '';
      if (devices.length === 0){
        const op = document.createElement('option');
        op.value = ''; op.textContent = 'No device';
        sel.appendChild(op);
      }else{
        devices.forEach(d=>{
          const op = document.createElement('option');
          op.value = d.deviceId; op.textContent = d.name || d.deviceId;
          sel.appendChild(op);
        });
        const saved = localStorage.getItem('deviceId');
        if (saved && [...sel.options].some(o=>o.value===saved)) sel.value = saved;
      }

      async function refreshAll(){
        if (!sel.value) { statusEl.textContent = 'Select a device first'; return; }
        statusEl.textContent = 'Loading‚Ä¶';
        try{
          await loadShadow(sel.value);
          await loadProgress(sel.value);
          statusEl.textContent = 'Updated';
        }catch(e){ showError(e); }
      }

      $('refreshBtn').onclick = refreshAll;
      sel.onchange = async ()=>{
        localStorage.setItem('deviceId', sel.value || '');
        await refreshAll();
      };

      await refreshAll();
      setInterval(()=> sel.value && loadProgress(sel.value).catch(showError), 60000);
    }catch(e){ showError(e); }
  });
  </script>
</body>
</html>
