<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <!-- กันเบราว์เซอร์ยิง /favicon.ico แล้ว 404 -->
  <link rel="icon" href="data:,">

  <!-- ธีมเดิมของคุณ -->
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices…</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">⟳</button>
    </div>
  </header>
<section class="dashboard" id="dashboard" hidden>
<div class="dash-hero">
  <div>
    <h1>Overview</h1>
    <div class="dash-level">Level <span id="growthLevelDash" class="level">-</span></div>

<div class="progress-lite dash-progress">
  <div class="track">
    <div id="barFillDash" class="fill"></div>
  </div>
  <div class="pct"><span id="pctTopDash">0</span>%</div>
</div>
    <div class="dash-kpis">
      <div class="dkpi"><small>Water </small><b id="dkpi-water">—</b></div>
      <div class="dkpi"><small>pH Level </small><b id="dkpi-ph">—</b></div>
      <div class="dkpi"><small>Temperature (°C) </small><b id="dkpi-temp">—</b></div>
    </div>
  </div>
</div>

<!-- PANELS (3 ใบ) -->
<div class="dash-panels">
  <!-- ซ้าย: Growth analytics (เข้ม) -->
  <div class="dash-card growth">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Growth analytics</h3>
    </div>
    <div class="dash-spark">
      <canvas id="spark" width="800" height="220" aria-label="pH & Temp chart"></canvas>
    </div>
    <div class="legend" style="margin-top:8px;font-size:12px;">
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#16a34a;margin-right:6px;"></span> pH
      &nbsp;&nbsp;
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2563eb;margin-right:6px;"></span> Temp
    </div>
  </div>

  <!-- กลาง: Critical Alerts (เหลือง) -->
  <div class="dash-card alerts">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Critical Alerts</h3>
    </div>
    <ul class="dash-alerts" id="dash-alerts">
      <li><span class="ok"></span> Optimal growth</li>
      <li><span class="warn"></span> Low water level</li>
      <li><span class="bad"></span> pH above normal</li>
    </ul>
  </div>

  <!-- ขวา: Activity Overview -->
  <div class="dash-card activity">
    <h3>Activity Overview</h3>
    <div class="dash-activity" id="dash-activity">
      <div class="dash-evt"><div><b>Watering System Adjustment</b><div><small>10:00–11:00</small></div></div><button class="dash-btn">Details</button></div>
      <div class="dash-evt"><div><b>Fertilizer Check</b><div><small>12:00–12:30</small></div></div><small>Completed</small></div>
      <div class="dash-evt"><div><b>Lighting Adjustment</b><div><small>16:00–18:00</small></div></div><small>In Progress</small></div>
    </div>
  </div>
</div>
</section>
<script>
/* ===================== ค่าคงเดิม ===================== */
const LIFF_ID = '2008085765-YDwJrxy9';
const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

/* ===================== DOM refs ===================== */
const $ = (id) => document.getElementById(id);
const statusEl = $('status');
const out = $('out');
const barFillDash = $('barFillDash');
const pctTopDash = $('pctTopDash');
const growthLevelDash = $('growthLevelDash');

const barFill = $('barFill');
const pctTop = $('pctTop');
const growthLevel = $('growthLevel');
const cta = $('ctaState');

const metricEls = { chl: $('mChl'), ph: $('mPh'), temp: $('mTemp'), ec: $('mEc') };

/* ===================== Utils ===================== */
function showError(err){
  console.error(err);
  const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
  if (statusEl) statusEl.textContent = 'Error: ' + msg;
  if (out) { out.style.display = 'block'; out.textContent = msg; }
}

function normalizeLevel(lvl){
  if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
  if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
    const n = parseInt(lvl, 10);
    return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
  }
  if (String(lvl).toLowerCase().includes('ready')) return '4';
  return String(lvl || '-');
}

function pickUpdated(d){
  if (d?.updatedAtIso) return d.updatedAtIso;
  const u = d?.updatedAt;
  if (!u) return '—';
  if (typeof u === 'string') return u;
  if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
  return String(u);
}

/* ===== หาค่าจาก shadow แบบเดาคีย์ทั่วไป (กันหลายชื่อ) ===== */
function getNum(obj, keys){
  const all = Object.keys(obj || {});
  const canon = s => String(s||'').toLowerCase();
  for (const k of all){
    const ck = canon(k);
    if (keys.some(q => ck.includes(canon(q)))){
      const v = Number(obj[k]);
      if (!Number.isNaN(v)) return v;
    }
  }
  for (const k of all){
    if (obj[k] && typeof obj[k] === 'object'){
      const v = getNum(obj[k], keys);
      if (typeof v === 'number') return v;
    }
  }
  return null;
}

function setMetric(el, val, suffix=''){
  if (!el) return;
  el.textContent = (val==null || Number.isNaN(val)) ? '—' : (suffix ? `${val}${suffix}` : String(val));
}

/* ===================== LINE Auth helpers ===================== */
function stripRedirectUri() { 
  return location.origin + location.pathname; 
}

async function ensureLogin() {
  if (liff.isLoggedIn()) return;
  const redirectUri = stripRedirectUri();
  if (liff.isInClient()) {
    liff.login();
  } else {
    liff.login({ withLoginOnExternalBrowser: true, redirectUri });
  }
  return new Promise(()=>{});
}

function buildAuthHeaders(){
  const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
  const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
  const h = { 'Content-Type': 'application/json' };
  if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
  else if (access) h['x-line-access-token'] = access;
  else throw new Error('No LINE token available');
  return h;
}

async function authedGet(url){
  const r = await fetch(url, { headers: buildAuthHeaders() });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.error) throw new Error(j.error || t);
  return j;
}

async function authedPost(url, body){
  const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
  const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
  if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
  return j;
}

/* ===================== Formatters (DKPI) ===================== */
const formatPh   = p => (p==null || Number.isNaN(+p)) ? '—' : (+p).toFixed(1);
const formatTemp = t => (t==null || Number.isNaN(+t)) ? '—' : `${(+t).toFixed(1)}°C`;
function formatWater(w){
  if (w==null || Number.isNaN(+w)) return '—';
  const n = +w;
  if (n <= 1)   return `${Math.round(n*100)}%`; // 0..1
  if (n <= 100) return `${Math.round(n)}%`;     // 0..100
  return String(n);
}

/* ===================== APIs (Progress/Shadow) ===================== */
async function getProgress(deviceId){
  const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
  const r = await fetch(url, { cache:'no-store' }); 
  const j = await r.json();
  if (!r.ok || j.error) throw new Error(j.error || JSON.stringify(j));
  return j; // {percent, level, goodNow, ...}
}

async function loadProgress(deviceId){
  const data = await getProgress(deviceId);
  const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
  const lvl = normalizeLevel(data.level);
  const updated = pickUpdated(data);

  if (pctTopDash) pctTopDash.textContent = pct!=null ? pct.toFixed(1) : '—';
  if (barFillDash) barFillDash.style.width = pct!=null ? `${pct}%` : '0%';
  if (growthLevelDash) growthLevelDash.textContent = lvl;

  if (statusEl) statusEl.textContent = `Updated: ${updated}`;
}


async function loadShadow(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid rev modified data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  if (out) out.textContent = JSON.stringify(r.data, null, 2);   // debug (ซ่อนใน UI จริง)
  const data = r?.data?.shadow?.data || {};

  const chl  = getNum(data, ['chloro','chlorophyll','par','ndvi','leaf']);
  const ph   = getNum(data, ['soil_ph','pH','ph']);
  const temp = getNum(data, ['temp','temperature','temp_c']);
  const ec   = getNum(data, ['soil_ec','ec','conductivity']);

  // อัปเดตซีรีส์ + วาดกราฟ
  updateSeries(deviceId, typeof ph==='number'?ph:null, typeof temp==='number'?temp:null);
  drawSpark(deviceId);

  return { data, ph, temp };
}

/* ===================== DKPI (บน Hero) ===================== */
async function renderDkpiForDevice(deviceId){
  const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
  const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
  const data = r?.data?.shadow?.data || {};

  const water = getNum(data, ['water_level','water','level','wl','water_percent','waterPct']);
  const ph    = getNum(data, ['soil_ph','pH','ph']);
  const temp  = getNum(data, ['temp','temperature','temp_c']);

  $('dkpi-water') && ($('dkpi-water').textContent = formatWater(water));
  $('dkpi-ph')    && ($('dkpi-ph').textContent    = formatPh(ph));
  $('dkpi-temp')  && ($('dkpi-temp').textContent  = formatTemp(temp));

  localStorage.setItem('deviceId', deviceId);
}

/* ===================== Sparkline (pH & Temp) ===================== */
const SERIES_MAX = 120; // เก็บจุดล่าสุด ~120 จุด
function seriesKey(deviceId){ return 'series_' + deviceId; }
function loadSeries(deviceId){
  try{ return JSON.parse(localStorage.getItem(seriesKey(deviceId))) || {t:[], ph:[], temp:[]}; }
  catch{ return {t:[], ph:[], temp:[]}; }
}
function saveSeries(deviceId, s){ localStorage.setItem(seriesKey(deviceId), JSON.stringify(s)); }
function updateSeries(deviceId, ph, temp){
  if (!deviceId || (ph==null && temp==null)) return;
  const s = loadSeries(deviceId);
  const now = Date.now();
  if (s.t.length && now - s.t[s.t.length-1] < 50*1000) {
    if (typeof ph   === 'number') s.ph[s.ph.length-1]     = ph;
    if (typeof temp === 'number') s.temp[s.temp.length-1] = temp;
  } else {
    s.t.push(now); s.ph.push(typeof ph==='number'?ph:null); s.temp.push(typeof temp==='number'?temp:null);
  }
  while (s.t.length > SERIES_MAX){ s.t.shift(); s.ph.shift(); s.temp.shift(); }
  saveSeries(deviceId, s);
}
function drawSpark(deviceId){
  const c = document.getElementById('spark'); if (!c) return;

  // ----- ขนาดที่ถูกต้องตาม CSS + DPI (ป้องกันตัวหนังสือบวม/ซ้อน) -----
  const rect = c.getBoundingClientRect();
  const cssW = Math.max(1, Math.floor(rect.width));
  const cssH = Math.max(1, Math.floor(rect.height));
  const dpr  = Math.max(1, Math.floor(window.devicePixelRatio || 1));

  if (c.width  !== cssW*dpr) c.width  = cssW*dpr;
  if (c.height !== cssH*dpr) c.height = cssH*dpr;

  const ctx = c.getContext('2d');
  ctx.setTransform(1,0,0,1,0,0); // reset
  ctx.scale(dpr, dpr);           // scale ตาม DPI
  ctx.clearRect(0,0,cssW,cssH);

  // ----- ดึงซีรีส์ -----
  const s = loadSeries(deviceId);
  const n = s.t.length; if (!n) return;

  const pad = { l: 40, r: 10, t: 18, b: 24 };
  const iw = cssW - pad.l - pad.r, ih = cssH - pad.t - pad.b;
  const idxs = [...Array(n).keys()];
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));

  // ===== สเกลอัตโนมัติ (พร้อม buffer) =====
  const phVals = s.ph.filter(v => typeof v === 'number');
  let phMin = phVals.length ? Math.min(...phVals) : 7;
  let phMax = phVals.length ? Math.max(...phVals) : 7;
  if (phMax === phMin) { phMax += 0.1; phMin -= 0.1; }
  const phPad = (phMax - phMin) * 0.15 + 0.1;
  phMin = clamp(phMin - phPad, 0, 14);
  phMax = clamp(phMax + phPad, 0.1, 14);

  const tVals = s.temp.filter(v => typeof v === 'number');
  let tMin = tVals.length ? Math.min(...tVals) : 25;
  let tMax = tVals.length ? Math.max(...tVals) : 25;
  if (tMax === tMin) { tMax += 0.5; tMin -= 0.5; }
  const tPad = (tMax - tMin) * 0.15 + 0.5;
  tMin = Math.max(0, tMin - tPad);
  tMax = tMax + tPad;

  const xAt = i => pad.l + (i / Math.max(1, n-1)) * iw;
  const yAt = (v, min, max) => pad.t + (1 - ((clamp(v,min,max)-min)/(max-min))) * ih;

  // ===== grid =====
  ctx.strokeStyle = 'rgba(255,255,255,.18)';
  ctx.lineWidth = 1;
  for (let g=0; g<=4; g++){
    const y = pad.t + g*(ih/4);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+iw, y); ctx.stroke();
  }

  // helper วาดเส้น
  function drawLine(arr, min, max, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    let moved = false;
    for (let i=0;i<n;i++){
      const val = arr[i];
      if (typeof val !== 'number') continue;
      const x = xAt(i), y = yAt(val, min, max);
      if (!moved){ ctx.moveTo(x,y); moved = true; } else ctx.lineTo(x,y);
    }
    if (moved) ctx.stroke();
  }

  // ===== เส้น pH (เขียว) + Temp (น้ำเงิน) =====
  drawLine(s.ph,   phMin, phMax, '#34d399');
  drawLine(s.temp, tMin,  tMax,  '#60a5fa');

  // ===== ป้ายสเกลด้านบนเล็ก ๆ =====
  ctx.fillStyle = 'rgba(255,255,255,.75)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.textAlign = 'left';
  ctx.fillText(`pH ${phMin.toFixed(1)}–${phMax.toFixed(1)}`, pad.l, pad.t - 4);
  ctx.textAlign = 'right';
  ctx.fillText(`Temp ${Math.round(tMin)}–${Math.round(tMax)}°C`, pad.l+iw, pad.t - 4);
}


/* ===================== Dashboard (Desktop) ===================== */
async function renderDashboard(){
  if (!window.matchMedia('(min-width:960px)').matches) return;
  const dash = $('dashboard'); if (dash) dash.hidden = false;

  const resp = await authedGet('/api/devices');
  const devices = Array.isArray(resp?.devices) ? resp.devices : [];

  const tbody = document.querySelector('#dash-table tbody'); 
  if (tbody) tbody.innerHTML = '';

  for (const d of devices){
    const tr = document.createElement('tr');
    const td = v => { const el=document.createElement('td'); el.textContent=v; return el; };

    let percentTxt = '—', health='—', dotCls='bad';
    try{
      const p = await getProgress(d.deviceId);
      if (typeof p.percent === 'number'){
        const pct = Math.round(p.percent);
        percentTxt = `${pct}%`;
        health = (pct>=80?'A+':pct>=60?'B':'C');
        dotCls = (pct>=80?'ok':pct>=60?'warn':'bad');
      }
    }catch{}

    let phTxt='—', tempTxt='—';
    try{
      const Q='query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
      const r=await authedPost('/api/gql',{query:Q,variables:{deviceid:d.deviceId}});
      const data=r?.data?.shadow?.data || {};
      const _ph = getNum(data,['soil_ph','pH','ph']);             if (typeof _ph === 'number') phTxt   = _ph.toFixed(1);
      const _t  = getNum(data,['temp','temperature','temp_c']);   if (typeof _t === 'number') tempTxt = _t.toFixed(1)+'°C';
    }catch{}

    const healthTd=document.createElement('td');
    const wrap=document.createElement('div'); wrap.className='dash-health';
    const dot=document.createElement('span'); dot.className='dot '+dotCls;
    const badge=document.createElement('span'); badge.className='dash-badge'; badge.textContent=health;
    wrap.append(dot,' ',badge); healthTd.appendChild(wrap);

    tr.append(healthTd, td(d.name||d.deviceId), td(percentTxt), td(phTxt), td(tempTxt));

    const btn=document.createElement('button'); btn.className='dash-btn'; btn.textContent='Select';
    btn.onclick = () => renderDkpiForDevice(d.deviceId).catch(console.error);
    const action=document.createElement('td'); action.appendChild(btn); tr.appendChild(action);

    tbody && tbody.appendChild(tr);
  }

  const initial = localStorage.getItem('deviceId') || devices[0]?.deviceId;
  if (initial) await renderDkpiForDevice(initial);
}

/* ===================== Boot ===================== */
window.addEventListener('DOMContentLoaded', async () => {
  try{
    await liff.init({ liffId: LIFF_ID });
    await ensureLogin();

    // clear LIFF query
    {
      const qs = new URLSearchParams(location.search);
      if (qs.get('code') || qs.get('liffRedirectUri')) {
        history.replaceState({}, '', stripRedirectUri());
      }
    }

    // cache token
    const idToken = liff.getIDToken();
    const accessToken = liff.getAccessToken();
    if (idToken) sessionStorage.setItem('line_id_token', idToken);
    if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

    const sel = $('deviceSelect');

    // โหลดรายการอุปกรณ์
    let devices = [];
    try{
      const resp = await authedGet('/api/devices');
      devices = Array.isArray(resp?.devices) ? resp.devices : [];
    }catch(e){ showError(e); }

    if (sel){
      sel.innerHTML = '';
      if (devices.length === 0){
        const op = document.createElement('option');
        op.value = ''; op.textContent = 'No device';
        sel.appendChild(op);
      }else{
        devices.forEach(d=>{
          const op = document.createElement('option');
          op.value = d.deviceId; op.textContent = d.name || d.deviceId;
          sel.appendChild(op);
        });
        const saved = localStorage.getItem('deviceId');
        if (saved && [...sel.options].some(o=>o.value===saved)) sel.value = saved;
      }
    }

    async function refreshAll(){
      if (!sel?.value) { if (statusEl) statusEl.textContent = 'Select a device first'; return; }
      if (statusEl) statusEl.textContent = 'Loading…';
      try{
        await loadShadow(sel.value);
        await loadProgress(sel.value);
        if (statusEl) statusEl.textContent = 'Updated';
      }catch(e){ showError(e); }
    }

    $('refreshBtn') && ($('refreshBtn').onclick = refreshAll);

    sel && (sel.onchange = async ()=>{
      localStorage.setItem('deviceId', sel.value || '');
      await refreshAll();
      if (window.matchMedia('(min-width:960px)').matches && sel.value){
        renderDkpiForDevice(sel.value).catch(console.error);
      }
    });

    await refreshAll();

    // refresh ทุก 60 วิ
    setInterval(()=> {
      if (!sel?.value) return;
      loadProgress(sel.value).catch(showError);
      loadShadow(sel.value).catch(showError);
    }, 60000);

    // dashboard (desktop)
    setTimeout(()=>renderDashboard().catch(console.error), 500);

    // วาดกราฟครั้งแรกจากซีรีส์เดิม (ถ้ามี)
    if (sel?.value) drawSpark(sel.value);

  }catch(e){ showError(e); }

  window.addEventListener('resize', () => {
  const sel = document.getElementById('deviceSelect');
  if (sel?.value) drawSpark(sel.value);
  })
});
</script>
</body>
</html>