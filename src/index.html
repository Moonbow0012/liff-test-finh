<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FINH LIFF</title>

  <!-- ‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏¥‡∏á /favicon.ico ‡πÅ‡∏•‡πâ‡∏ß 404 -->
  <link rel="icon" href="data:,">

  <!-- ‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
  <link rel="preload" as="style" href="/finh-theme.css?v=1">
  <link rel="stylesheet" href="/finh-theme.css?v=1">

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <!-- Top bar -->
  <header class="topbar">
    <div class="brand"><img src="./assets/finh_logo.png" alt="FINH"></div>
    <div class="right">
      <select id="deviceSelect" title="Select device">
        <option value="" selected disabled>Loading devices‚Ä¶</option>
      </select>
      <button id="refreshBtn" class="icon-btn" title="Refresh">‚ü≥</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero + Title -->
    <div class="hero"><img src="./assets/organic.png" alt="organic"></div>
    <div class="center">
      <div class="title">Peak Protein</div>
      <div class="sub">Level <span id="growthLevel">-</span></div>
    </div>

    <!-- Progress -->
    <div class="progress-lite">
      <div class="track"><div id="barFill" class="fill"></div></div>
      <div class="pct"><span id="pctTop">0</span>%</div>
    </div>

    <!-- Status Card -->
    <section class="card" id="statusCard">
      <h3>Status</h3>
      <ul class="metrics">
        <li>
          <div class="metric-left">
            <div class="ic">üçÉ</div><div>Chlorophyll</div>
          </div>
          <div class="val" id="mChl">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üíß</div><div>Soil pH</div>
          </div>
          <div class="val" id="mPh">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">üå°Ô∏è</div><div>Temp</div>
          </div>
          <div class="val" id="mTemp">‚Äî</div>
        </li>
        <li>
          <div class="metric-left">
            <div class="ic">‚ö°</div><div>Soil EC</div>
          </div>
          <div class="val" id="mEc">‚Äî</div>
        </li>
      </ul>
    </section>

    <!-- Big CTA -->
    <button id="ctaState" class="cta">Not Ready Yet</button>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î + debug -->
    <div id="status" style="color:#fff; margin:10px 4px;"></div>
    <pre id="out" class="log">‚Äî</pre>
  </main>
  <section class="dashboard" id="dashboard" hidden>
  <div class="dash-hero">
    <div>
      <h1>Overview</h1>
      <div class="dash-kpis">
        <div class="dkpi"><small>Water</small><b id="dkpi-water">‚Äî</b></div>
        <div class="dkpi"><small>pH Level</small><b id="dkpi-ph">‚Äî</b></div>
        <div class="dkpi"><small>Temperature</small><b id="dkpi-temp">‚Äî</b></div>
      </div>
    </div>
    <div class="dash-plant" aria-hidden="true"></div>
  </div>

  <div class="dash-panels">
    <div class="dash-card">
      <h3>Growth analytics</h3>
      <div class="dash-spark" id="dash-spark">12‚Äì30 day chart slot</div>
    </div>
    <div class="dash-card">
      <h3>Critical Alerts</h3>
      <ul class="dash-alerts" id="dash-alerts"></ul>
    </div>
    <div class="dash-card">
      <h3>Activity Overview</h3>
      <div class="dash-activity" id="dash-activity"></div>
    </div>
  </div>

  <div class="dash-table-wrap">
    <h3>Active Ponds</h3>
    <table class="dash-table" id="dash-table" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠">
      <thead><tr><th>HEALTH</th><th>POND</th><th>WATER</th><th>pH</th><th>TEMP</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

  <script>
  // ======== ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ Backend/Firebase) =========
  const LIFF_ID = '2008085765-YDwJrxy9';
  const FIREBASE_PROGRESS_URL = 'https://getprogress-iyipepekja-as.a.run.app';

  const $ = (id) => document.getElementById(id);
  const statusEl = $('status');
  const out = $('out');

  const barFill = $('barFill');
  const pctTop = $('pctTop');
  const growthLevel = $('growthLevel');
  const cta = $('ctaState');

  const metricEls = { chl: $('mChl'), ph: $('mPh'), temp: $('mTemp'), ec: $('mEc') };

  function showError(err){
    console.error(err);
    const msg = (typeof err === 'string') ? err : (err?.message || JSON.stringify(err));
    statusEl.textContent = 'Error: ' + msg;
    out.style.display = 'block';
    out.textContent = msg;
  }

  function buildAuthHeaders(){
    const idToken = sessionStorage.getItem('line_id_token') || liff.getIDToken();
    const access  = sessionStorage.getItem('line_access_token') || liff.getAccessToken();
    const h = { 'Content-Type': 'application/json' };
    if (idToken && idToken.includes('.')) h['x-line-id-token'] = idToken;
    else if (access) h['x-line-access-token'] = access;
    else throw new Error('No LINE token available');
    return h;
  }
  async function authedGet(url){
    const r = await fetch(url, { headers: buildAuthHeaders() });
    const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.error) throw new Error(j.error || t);
    return j;
  }
  async function authedPost(url, body){
    const r = await fetch(url, { method:'POST', headers: buildAuthHeaders(), body: JSON.stringify(body||{}) });
    const t = await r.text(); let j; try{ j = JSON.parse(t); }catch{ throw new Error(`HTTP ${r.status}: ${t}`); }
    if (!r.ok || j.errors) throw new Error(j.errors ? JSON.stringify(j.errors) : t);
    return j;
  }

  function normalizeLevel(lvl){
    if (typeof lvl === 'number') return ['1','2','3','4'][Math.max(0, Math.min(3, lvl))] || String(lvl);
    if (typeof lvl === 'string' && /^\d+$/.test(lvl)) {
      const n = parseInt(lvl, 10);
      return ['1','2','3','4'][Math.max(0, Math.min(3, n))] || lvl;
    }
    if (String(lvl).toLowerCase().includes('ready')) return '4';
    return String(lvl || '-');
  }

  function pickUpdated(d){
    if (d.updatedAtIso) return d.updatedAtIso;
    const u = d.updatedAt;
    if (!u) return '‚Äî';
    if (typeof u === 'string') return u;
    if (u && typeof u === 'object' && '_seconds' in u) return new Date(u._seconds * 1000).toISOString();
    return String(u);
  }

  // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å shadow ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)
  function getNum(obj, keys){
    const all = Object.keys(obj || {});
    // ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÅ‡∏ö‡∏ö contains (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà / _ .)
    const canon = s => String(s||'').toLowerCase();
    for (const k of all){
      const ck = canon(k);
      if (keys.some(q => ck.includes(canon(q)))){
        const v = Number(obj[k]);
        if (!Number.isNaN(v)) return v;
      }
    }
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö data ‡∏ã‡πâ‡∏≠‡∏ô
    for (const k of all){
      if (obj[k] && typeof obj[k] === 'object'){
        const v = getNum(obj[k], keys);
        if (typeof v === 'number') return v;
      }
    }
    return null;
  }

  function setMetric(el, val, suffix=''){
    el.textContent = (val==null || Number.isNaN(val)) ? '‚Äî' : (suffix ? `${val}${suffix}` : String(val));
  }

  async function loadShadow(deviceId){
    const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid rev modified data } }';
    const r = await authedPost('/api/gql', { query: Q, variables: { deviceid: deviceId }});
    out.textContent = JSON.stringify(r.data, null, 2);   // debug ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ)
    const data = r?.data?.shadow?.data || {};

    // ‡πÄ‡∏î‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const chl  = getNum(data, ['chloro','chlorophyll','par','ndvi','leaf']);
    const ph   = getNum(data, ['soil_ph','pH','ph']);
    const temp = getNum(data, ['temp','temperature']);
    const ec   = getNum(data, ['soil_ec','ec','conductivity']);

    setMetric(metricEls.chl,  chl!=null ? +chl.toFixed(1) : null);
    setMetric(metricEls.ph,   ph!=null ? +ph.toFixed(2) : null);
    setMetric(metricEls.temp, temp!=null ? +temp.toFixed(1) : null, '¬∞C');
    setMetric(metricEls.ec,   ec!=null ? +ec.toFixed(3) : null);
  }

  async function loadProgress(deviceId){
    const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
    const r = await fetch(url, { cache:'no-store' });
    const data = await r.json();
    if (!r.ok || data.error) throw new Error(data.error || JSON.stringify(data));

    const pct = typeof data.percent === 'number' ? Math.max(0, Math.min(100, data.percent)) : null;
    const lvl = normalizeLevel(data.level);
    const good = ('Status' in data) ? !!data.Status : !!data.goodNow;
    const updated = pickUpdated(data);

    pctTop.textContent = pct!=null ? pct.toFixed(1) : '‚Äî';
    barFill.style.width = pct!=null ? `${pct}%` : '0%';
    growthLevel.textContent = lvl;

    cta.textContent = good ? 'Ready!' : 'Not Ready Yet';
    cta.classList.toggle('ready', good);

    statusEl.textContent = `Updated: ${updated}`;
  }

    // --- ADD: helpers for LIFF login flow ---
  function stripRedirectUri() { 
    // ‡πÉ‡∏´‡πâ URL ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡∏Å‡∏±‡∏ô loop ‡∏à‡∏≤‡∏Å ?code / ?liffRedirectUri)
    return location.origin + location.pathname; 
  }

  async function ensureLogin() {
    if (liff.isLoggedIn()) return;

    const redirectUri = stripRedirectUri();

    if (liff.isInClient()) {
      // ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà scope/prompt/redirectUri
      // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ consent (‚ÄúAllow‚Äù) ‡πÇ‡∏ú‡∏•‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á LINE ‡πÄ‡∏≠‡∏á
      liff.login();
    } else {
      // ‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ ‚Üí ‡πÉ‡∏ä‡πâ external browser + redirectUri ‡∏™‡∏∞‡∏≠‡∏≤‡∏î
      liff.login({ withLoginOnExternalBrowser: true, redirectUri });
    }

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    return new Promise(()=>{});
  }

  window.addEventListener('DOMContentLoaded', async () => {
    try{
      await liff.init({ liffId: LIFF_ID });
      await ensureLogin();

{
  const qs = new URLSearchParams(location.search);
  if (qs.get('code') || qs.get('liffRedirectUri')) {
    history.replaceState({}, '', stripRedirectUri());
  }
}

      // cache token
      const idToken = liff.getIDToken();
      const accessToken = liff.getAccessToken();
      if (idToken) sessionStorage.setItem('line_id_token', idToken);
      if (accessToken) sessionStorage.setItem('line_access_token', accessToken);

      const sel = $('deviceSelect');

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      let devices = [];
      try{
        const resp = await authedGet('/api/devices');
        devices = Array.isArray(resp?.devices) ? resp.devices : [];
      }catch(e){ showError(e); }

      sel.innerHTML = '';
      if (devices.length === 0){
        const op = document.createElement('option');
        op.value = ''; op.textContent = 'No device';
        sel.appendChild(op);
      }else{
        devices.forEach(d=>{
          const op = document.createElement('option');
          op.value = d.deviceId; op.textContent = d.name || d.deviceId;
          sel.appendChild(op);
        });
        const saved = localStorage.getItem('deviceId');
        if (saved && [...sel.options].some(o=>o.value===saved)) sel.value = saved;
      }

      async function refreshAll(){
        if (!sel.value) { statusEl.textContent = 'Select a device first'; return; }
        statusEl.textContent = 'Loading‚Ä¶';
        try{
          await loadShadow(sel.value);
          await loadProgress(sel.value);
          statusEl.textContent = 'Updated';
        }catch(e){ showError(e); }
      }

      $('refreshBtn').onclick = refreshAll;
      sel.onchange = async ()=>{
        localStorage.setItem('deviceId', sel.value || '');
        await refreshAll();
      };

      await refreshAll();
      setInterval(()=> sel.value && loadProgress(sel.value).catch(showError), 60000);
    }catch(e){ showError(e); }
  });

  async function getProgress(deviceId){
  const url = `${FIREBASE_PROGRESS_URL}?deviceId=${encodeURIComponent(deviceId)}`;
  const r = await fetch(url, { cache:'no-store' }); const j = await r.json();
  if (!r.ok || j.error) throw new Error(j.error || JSON.stringify(j));
  return j; // {percent, level, goodNow, ...}
}
function td(v){ const el=document.createElement('td'); el.textContent=v; return el; }

async function renderDashboard(){
  // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ layout desktop ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà
  if (window.matchMedia('(min-width:960px)').matches) {
    document.getElementById('dashboard').hidden = false;
  } else { return; }

  // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
  const resp = await authedGet('/api/devices');
  const devices = Array.isArray(resp?.devices) ? resp.devices : [];

  // 2) ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡πà‡∏≠
  const tbody = document.querySelector('#dash-table tbody'); tbody.innerHTML = '';
  let waterArr=[], phArr=[], tempArr=[];
  for (const d of devices){
    const p = await getProgress(d.deviceId);
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥ KPI ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ)
    if (typeof p.percent === 'number') waterArr.push(p.percent);
    // ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ ph/temp ‡∏à‡∏≤‡∏Å shadow ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÜ
    try{
      const Q = 'query($deviceid:String!){ shadow(deviceid:$deviceid){ data } }';
      const r = await authedPost('/api/gql',{ query:Q, variables:{ deviceid:d.deviceId }});
      const data = r?.data?.shadow?.data || {};
      const ph   = getNum(data, ['soil_ph','pH','ph']); if (typeof ph === 'number') phArr.push(ph);
      const temp = getNum(data, ['temp','temperature']); if (typeof temp === 'number') tempArr.push(temp);
      // ‡πÅ‡∏ñ‡∏ß
      const tr=document.createElement('tr');
      const health = (p.percent>=80?'A+':p.percent>=60?'B':'C');
      const dot = document.createElement('span'); dot.className='dot ' + (p.percent>=80?'ok':p.percent>=60?'warn':'bad');
      const badge = document.createElement('span'); badge.className='dash-badge'; badge.textContent = health;
      const htd = document.createElement('td'); const wrap=document.createElement('div'); wrap.className='dash-health'; wrap.append(dot,' ',badge); htd.appendChild(wrap);

      tr.append(htd, td(d.name||d.deviceId), td(`${Math.round(p.percent)}%`), td(ph??'‚Äî'), td(temp!=null?`${temp}¬∞C`:'‚Äî'));
      const btn=document.createElement('button'); btn.className='dash-btn'; btn.textContent='Details';
      btn.onclick=()=>{ localStorage.setItem('deviceId', d.deviceId); location.href = location.pathname + '#mobile'; };
      const actionTd=document.createElement('td'); actionTd.appendChild(btn); tr.appendChild(actionTd);
      tbody.appendChild(tr);
    }catch{}
  }

  // 3) KPI ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
  const avg = a => a.length? (a.reduce((x,y)=>x+y,0)/a.length) : null;
  const w = avg(waterArr), ph = avg(phArr), t = avg(tempArr);
  document.getElementById('dkpi-water').textContent = w!=null ? `${Math.round(w)}%` : '‚Äî';
  document.getElementById('dkpi-ph').textContent    = ph!=null ? ph.toFixed(1)   : '‚Äî';
  document.getElementById('dkpi-temp').textContent  = t!=null ? `${t.toFixed(1)}¬∞C` : '‚Äî';

  // 4) ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Alerts/Activity ‡πÅ‡∏ö‡∏ö mock (‡∏Ñ‡∏∏‡∏ì‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ)
  const alerts = document.getElementById('dash-alerts');
  alerts.innerHTML = `
    <li><span class="ok"></span> Optimal growth</li>
    <li><span class="warn"></span> Low water level</li>
    <li><span class="bad"></span> pH above normal</li>`;
  const act = document.getElementById('dash-activity');
  act.innerHTML = `
    <div class="dash-evt"><div><b>Watering System Adjustment</b><div><small>10:00‚Äì11:00</small></div></div><button class="dash-btn">Details</button></div>
    <div class="dash-evt"><div><b>Fertilizer Check</b><div><small>12:00‚Äì12:30</small></div></div><small>Completed</small></div>
    <div class="dash-evt"><div><b>Lighting Adjustment</b><div><small>16:00‚Äì18:00</small></div></div><small>In Progress</small></div>`;
}
// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á from your existing init flow:
window.addEventListener('DOMContentLoaded', ()=> {
  // ‡∏´‡∏•‡∏±‡∏á ensureLogin + token cached + refreshAll ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
  setTimeout(()=>renderDashboard().catch(console.error), 500);
});
  </script>
</body>
</html>
