<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  const LIFF_ID = 'YOUR_LIFF_ID'; // ใส่ของจริง
  const Q_SHADOW = `query($deviceid:String!){ shadow(deviceid:$deviceid){ deviceid data rev modified } }`;

  const $ = (id) => document.getElementById(id);

  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { liff.login(); return; }

  const idToken = liff.getIDToken();

  async function authedGet(url){
    const r = await fetch(url, { headers: { 'x-line-id-token': idToken }});
    if(!r.ok) throw new Error(await r.text()); return r.json();
  }
  async function authedPost(url, body){
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'application/json', 'x-line-id-token': idToken },
      body: JSON.stringify(body)
    });
    const t = await r.text(); let j; try{ j=JSON.parse(t);}catch{ throw new Error(`HTTP ${r.status}: ${t}`);}
    if(!r.ok || j.errors) throw new Error(t);
    return j;
  }

  // สร้าง UI อย่างง่าย
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <h3>Devices</h3>
    <select id="deviceSelect"></select>
    <button id="refreshBtn">Refresh</button>
    <pre id="out">—</pre>
  `;
  document.body.appendChild(wrap);
  const sel = $('deviceSelect'), refreshBtn = $('refreshBtn'), out = $('out');

  // โหลดรายการอุปกรณ์จาก backend (ที่กรอง/อนุญาตแล้ว)
  const { devices } = await authedGet('/api/devices');
  devices.forEach(d => {
    const op = document.createElement('option');
    op.value = d.deviceId; op.textContent = d.name || d.deviceId;
    sel.appendChild(op);
  });
  const saved = localStorage.getItem('deviceId');
  if (saved && [...sel.options].some(o => o.value === saved)) sel.value = saved;

  sel.onchange = () => localStorage.setItem('deviceId', sel.value);

  async function refresh() {
    const variables = { deviceid: sel.value };
    const r = await authedPost('/api/gql', { query: Q_SHADOW, variables });
    out.textContent = JSON.stringify(r.data, null, 2);
  }

  refreshBtn.onclick = refresh;
  await refresh(); // โหลดครั้งแรก
})();
</script>
