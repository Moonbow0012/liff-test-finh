<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GAqP Self-Audit (Wolffia)</title>
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <!-- NEW: Chart.js สำหรับวาด Pie -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7faf9; color:#0f172a; }
    .hdr { display:flex; gap:12px; align-items:center; padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10; }
    .logo { height:36px; }
    .wrap { max-width: 900px; margin: 16px auto 80px; padding: 0 12px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:12px 0; box-shadow: 0 1px 0 rgba(16,24,40,.04); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    label.inline { display:flex; align-items:center; gap:8px; }
    input[type="text"] { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px; background:#fff; }
    .btn { appearance:none; border:1px solid #0ea5e9; background:#0ea5e9; color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; }
    .btn.outline { background:#fff; border-color:#94a3b8; color:#334155; }
    .muted { color:#64748b; font-size:12px; }
    .sec { border:1px solid #e2e8f0; border-radius:12px; margin:10px 0; overflow:hidden; }
    .sec-hdr { background:#f1f5f9; padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .sec-body { padding:10px 12px; display:none; }
    .q { border-top:1px dashed #e5e7eb; padding:10px 0; }
    .q:first-child { border-top:0; }
    .q-title { font-weight:600; margin-bottom:8px; }
    .q-grid { display:grid; grid-template-columns: 1fr; gap:8px; }
    .sticky-foot { position:fixed; left:0; right:0; bottom:0; background:#ffffffd9; backdrop-filter: blur(6px);
      border-top:1px solid #e5e7eb; padding:10px 12px; display:flex; justify-content:center; }
    /* NEW: การ์ดผลลัพธ์ */
    .result-head { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .kpi { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi > div { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:8px 12px; }
  </style>
</head>
<body>
  <header class="hdr">
    <img src="./finh_logo.png" alt="logo" class="logo" onerror="this.style.display='none'"/>
    <div>
      <div style="font-weight:700">GAqP Self-Audit (Wolffia)</div>
      <div class="muted">แบบประเมินระบบการเลี้ยงเบื้องต้น (11 หมวด)</div>
    </div>
  </header>

  <div class="wrap">
    <!-- ผู้ใช้ -->
    <section class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div class="row" style="align-items:center;">
          <img id="uimg" class="avatar" alt="avatar" style="width:40px;height:40px;border-radius:999px;border:1px solid #e5e7eb;object-fit:cover"/>
          <div>
            <div id="uname" style="font-weight:600">...</div>
            <div id="uid" class="muted">uid: -</div>
          </div>
        </div>
        <button id="logout" class="btn outline">ออกจากระบบ</button>
      </div>
    </section>

    <!-- ข้อมูลฟาร์ม -->
    <section class="card" id="farmCard">
      <div class="row">
        <label style="flex:1">ฟาร์ม (farmId)<br><input name="farmId" id="farmId" placeholder="เช่น farm-1"></label>
        <label style="flex:1">แปลง (plotId)<br><input name="plotId" id="plotId" placeholder="เช่น P01"></label>
      </div>
      <div class="muted" style="margin-top:6px">* ไม่บังคับกรอกครบ ส่งเพื่อเก็บข้อมูลได้เลย</div>
    </section>

    <!-- แบบประเมิน -->
    <form id="auditForm" class="card" style="padding:0">
      <div id="sections"></div>
      <div style="padding:12px">
        <label class="inline"><input type="checkbox" id="consent" required> ยินยอมให้เก็บและใช้ข้อมูลตาม Privacy Notice</label>
      </div>
    </form>

    <!-- NEW: การ์ดสรุปผลหลังส่ง -->
    <section id="resultCard" class="card" style="display:none">
      <div class="result-head">
        <div>
          <div style="font-weight:700">สรุปผลการประเมิน</div>
          <div class="muted" id="resultSummary">—</div>
        </div>
        <button class="btn outline" id="closeBtn">ปิดหน้าต่าง</button>
      </div>
      <div class="kpi" style="margin:12px 0">
        <div><b id="kPass">ผ่าน: 0</b></div>
        <div><b id="kFail">ไม่ผ่าน: 0</b></div>
        <div><b id="kPct">ผ่าน (%) : 0%</b></div>
      </div>
      <canvas id="pie" width="380" height="380" style="max-width:100%"></canvas>
      <div class="muted" style="margin-top:10px">* แสดงผลเฉพาะคำตอบที่เลือก “ผ่าน/ไม่ผ่าน”</div>
    </section>
  </div>

  <div class="sticky-foot" id="footBar">
    <button id="submitBtn" class="btn">บันทึกข้อมูล</button>
  </div>

<script>
/* ======= ตั้งค่าโปรเจกต์คุณ ======= */
const LIFF_ID    = "2008118596-nMd5qQ38";
const AUTH_URL   = "https://authline-iyipepekja-as.a.run.app";
const CREATE_URL = "https://createissue-iyipepekja-as.a.run.app";
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCnNQdOzThqmT3Wgvir2x4yrpiygKQKbV8",
  authDomain: "finh-iot-ai.firebaseapp.com",
  projectId: "finh-iot-ai"
};
/* ======= จบส่วนตั้งค่า ======= */

const REQUIRED_SCOPE = ['openid','profile','email'];
const $ = (s)=>document.querySelector(s);

// 11 หมวด
const SECTIONS = [/* ... เหมือนเดิมของคุณทั้งหมด ... */];
</script>

<script>
function renderSections(){
  const host = document.querySelector("#sections");
  host.innerHTML = "";
  SECTIONS.forEach(sec=>{
    const secEl = document.createElement("div");
    secEl.className = "sec";
    secEl.innerHTML = `
      <div class="sec-hdr" data-sec="${sec.id}">
        <div><b>${sec.id}. ${sec.title}</b></div>
        <div>▶</div>
      </div>
      <div class="sec-body" id="sec-${sec.id}"></div>
    `;
    host.appendChild(secEl);

    const body = secEl.querySelector(".sec-body");
    sec.items.forEach((text, idx)=>{
      const qId = `${sec.id}_${idx+1}`;
      const q = document.createElement("div");
      q.className = "q";
      q.innerHTML = `
        <div class="q-title">${sec.id}.${idx+1} ${text}</div>
        <div class="q-grid">
          <div class="row">
            <label class="inline"><input type="radio" name="pass_${qId}" value="PASS"> ผ่าน</label>
            <label class="inline"><input type="radio" name="pass_${qId}" value="FAIL"> ไม่ผ่าน</label>
          </div>
        </div>
      `;
      body.appendChild(q);
    });
  });

  // toggle accordion
  host.querySelectorAll(".sec-hdr").forEach(h=>{
    h.addEventListener("click", ()=>{
      const body = h.nextElementSibling;
      body.style.display = (body.style.display === "block") ? "none" : "block";
    });
  });

  // เปิดหมวดแรก
  const first = host.querySelector(".sec-body");
  if (first) first.style.display = "block";
}

// ==== NEW: Summary + Chart helpers ====
function summarizeAudit(auditAnswers) {
  const out = { pass:0, fail:0, total:0, passPct:0, failPct:0 };
  for (const x of (auditAnswers||[])) {
    if (x?.result === "PASS") out.pass++;
    else if (x?.result === "FAIL") out.fail++;
  }
  out.total = out.pass + out.fail;
  if (out.total > 0) {
    out.passPct = Math.round((out.pass / out.total) * 100);
    out.failPct = 100 - out.passPct;
  }
  return out;
}

let pieChart = null;
function drawPie(passCount, failCount) {
  const ctx = document.getElementById("pie").getContext("2d");
  // destroy ก่อนวาดใหม่
  if (pieChart) { pieChart.destroy(); pieChart = null; }

  const total = passCount + failCount;

  if (total === 0) {
    // เคสไม่มีคำตอบเลย — วาดชิ้นเดียวเพื่อให้กราฟขึ้น
    pieChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["ยังไม่มีคำตอบ"],
        datasets: [{ data: [1] }]
      },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });
    return;
  }

  const passPct = Math.round((passCount / total) * 100);
  const failPct = 100 - passPct;

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: [`ผ่าน ${passPct}%`, `ไม่ผ่าน ${failPct}%`],
      datasets: [{ data: [passCount, failCount] }]
    },
    options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
  });
}

// ==== Auth helpers (เหมือนเดิม) ====
async function getFreshLineIdToken(){
  if (!liff.isLoggedIn()) {
    liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href });
    return new Promise(()=>{});
  }
  const idToken = liff.getIDToken();
  const decoded = liff.getDecodedIDToken?.();
  if (!idToken || !decoded) { liff.logout(); liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href }); return new Promise(()=>{}); }
  const expMs = (decoded.exp||0)*1000;
  if (Date.now() > expMs - 15000) { liff.logout(); liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href }); return new Promise(()=>{}); }
  return idToken;
}

async function exchangeToFirebaseToken(lineIdToken){
  const r = await fetch(AUTH_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ idToken: lineIdToken })
  });
  let js = null;
  try { js = await r.json(); } catch {}
  if (!r.ok) {
    const msg = `${js?.error ?? ''}${js?.message ? `: ${js.message}` : ''}`.trim() || `authLine HTTP ${r.status}`;
    throw new Error(msg);
  }
  return js.firebaseToken;
}

function collectAuditData(){
  const farmId = (document.querySelector("#farmId").value || "").trim() || null;
  const plotId = (document.querySelector("#plotId").value || "").trim() || null;
  const answers = [];
  SECTIONS.forEach(sec=>{
    sec.items.forEach((text, idx)=>{
      const qId = `${sec.id}_${idx+1}`;
      const val = (document.querySelector(`input[name="pass_${qId}"]:checked`)||{}).value || null;
      answers.push({ sectionId: sec.id, sectionTitle: sec.title, itemNo: `${sec.id}.${idx+1}`, text, result: val });
    });
  });
  return { farmId, plotId, answers };
}

// ==== Main ====
window.addEventListener('DOMContentLoaded', async () => {
  renderSections();

  try {
    await liff.init({ liffId: LIFF_ID });
    const lineIdToken = await getFreshLineIdToken();

    // โปรไฟล์
    const prof = await liff.getProfile();
    document.querySelector("#uimg").src = prof.pictureUrl || "";
    document.querySelector("#uname").textContent = prof.displayName || "LINE User";
    document.querySelector("#uid").textContent = `uid: ${prof.userId}`;
    document.querySelector("#logout").onclick = ()=>{ liff.logout(); location.reload(); };

    // แลก custom token + sign in Firebase
    const firebaseToken = await exchangeToFirebaseToken(lineIdToken);
    if (!firebase.apps?.length) firebase.initializeApp(FIREBASE_CONFIG);
    await firebase.auth().signInWithCustomToken(firebaseToken);

    // ปุ่มปิดหน้าต่าง (ให้ลูกค้ากดเอง)
    document.querySelector("#closeBtn").onclick = ()=>{
      if (liff.isInClient()) liff.closeWindow();
      else window.close();
    };

    // ปุ่มบันทึก
    document.querySelector("#submitBtn").onclick = async ()=>{
      try{
        if (!document.querySelector("#consent").checked) return alert("กรุณายินยอมก่อนส่ง");
        const { farmId, plotId, answers } = collectAuditData();

        // Firebase ID token สำหรับ backend
        const fbIdToken = await firebase.auth().currentUser.getIdToken(true);

        const payload = {
          farmId, plotId,
          description: "GAqP self-audit (data-only)",
          consent: true,
          auditAnswers: answers
        };

        // บันทึกไป backend
        const r = await fetch(CREATE_URL, {
          method:"POST",
          headers: { "Content-Type":"application/json", "Authorization": "Bearer " + fbIdToken },
          body: JSON.stringify(payload)
        });
        const js = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(js?.error || "บันทึกไม่สำเร็จ");

        // NEW: สรุปผล + วาดกราฟ แล้วแสดงการ์ดผลลัพธ์
        const stats = summarizeAudit(answers);
        drawPie(stats.pass, stats.fail);
        document.getElementById("kPass").textContent = `ผ่าน: ${stats.pass}`;
        document.getElementById("kFail").textContent = `ไม่ผ่าน: ${stats.fail}`;
        document.getElementById("kPct").textContent  = `ผ่าน (%): ${stats.passPct}%`;
        document.getElementById("resultSummary").textContent =
          `บันทึกสำเร็จ (รหัส ${js.issueId || '-'}) • รวม ${stats.total} ข้อ`;

        // ซ่อนฟอร์ม & แสดงผล
        document.getElementById("auditForm").style.display = "none";
        document.getElementById("farmCard").style.display = "none";
        document.getElementById("footBar").style.display  = "none";
        document.getElementById("resultCard").style.display = "block";

      }catch(e){
        console.error(e);
        alert(e.message || "บันทึกไม่สำเร็จ");
      }
    };

  } catch (err) {
    console.error(err);
    alert(err.message || "เริ่มต้นระบบไม่สำเร็จ");
  }
});
</script>
</body>
</html>
