<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GAqP Self-Audit (Wolffia)</title>

  <!-- SDKs -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; background:#f7faf9; color:#0f172a; }
    .hdr { display:flex; gap:12px; align-items:center; padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10; }
    .logo { height:36px; }
    .wrap { max-width: 900px; margin: 16px auto 80px; padding: 0 12px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:12px 0; box-shadow: 0 1px 0 rgba(16,24,40,.04); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    label.inline { display:flex; align-items:center; gap:8px; }
    input[type="text"] { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px; background:#fff; }
    .btn { appearance:none; border:1px solid #0ea5e9; background:#0ea5e9; color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; }
    .btn.outline { background:#fff; border-color:#94a3b8; color:#334155; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#64748b; font-size:12px; }
    .sec { border:1px solid #e2e8f0; border-radius:12px; margin:10px 0; overflow:hidden; }
    .sec-hdr { background:#f1f5f9; padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .sec-body { padding:10px 12px; display:none; }
    .q { border-top:1px dashed #e5e7eb; padding:10px 0; }
    .q:first-child { border-top:0; }
    .q-title { font-weight:600; margin-bottom:8px; }
    .q-grid { display:grid; grid-template-columns: 1fr; gap:8px; }
    .sticky-foot { position:fixed; left:0; right:0; bottom:0; background:#ffffffd9; backdrop-filter: blur(6px);
      border-top:1px solid #e5e7eb; padding:10px 12px; display:flex; justify-content:center; }

    /* ผลลัพธ์ */
    #resultCard h3 { margin: 0 0 8px 0; }
    #resultStats { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    #resultStats .pill { background:#f1f5f9; border:1px solid #e2e8f0; padding:6px 10px; border-radius:999px; font-size:12px; }
    #resultMsg { margin-top:8px; font-size:12px; color:#64748b; }
  </style>
</head>
<body>
  <header class="hdr">
    <img src="./finh_logo.png" alt="logo" class="logo" onerror="this.style.display='none'"/>
    <div>
      <div style="font-weight:700">GAqP Self-Audit (Wolffia)</div>
      <div class="muted">แบบประเมินระบบการเลี้ยงเบื้องต้น (11 หมวด)</div>
    </div>
  </header>

  <div class="wrap">
    <!-- ผู้ใช้ -->
    <section id="userCard" class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div class="row" style="align-items:center;">
          <img id="uimg" class="avatar" alt="avatar" style="width:40px;height:40px;border-radius:999px;border:1px solid #e5e7eb;object-fit:cover"/>
          <div>
            <div id="uname" style="font-weight:600">...</div>
            <div id="uid" class="muted">uid: -</div>
          </div>
        </div>
        <button id="logout" class="btn outline">ออกจากระบบ</button>
      </div>
    </section>

    <!-- ข้อมูลฟาร์ม -->
    <section class="card">
      <div class="row">
        <label style="flex:1">ฟาร์ม (farmId)<br><input name="farmId" id="farmId" placeholder="เช่น farm-1"></label>
        <label style="flex:1">แปลง (plotId)<br><input name="plotId" id="plotId" placeholder="เช่น P01"></label>
      </div>
      <div class="muted" style="margin-top:6px">* ไม่บังคับกรอกครบ ส่งเพื่อเก็บข้อมูลได้เลย</div>
    </section>

    <!-- แบบประเมิน -->
    <form id="auditForm" class="card" style="padding:0">
      <div id="sections"></div>
      <div style="padding:12px">
        <label class="inline"><input type="checkbox" id="consent" required> ยินยอมให้เก็บและใช้ข้อมูลตาม Privacy Notice</label>
      </div>
    </form>

    <!-- สรุปผล (แสดงหลังส่ง) -->
    <section id="resultCard" class="card" style="display:none">
      <h3>สรุปผลแบบประเมิน</h3>
      <div style="max-width:360px;margin:10px auto;">
        <canvas id="pieCanvas" height="300"></canvas>
      </div>
      <div id="resultStats"></div>
      <div id="resultMsg" class="muted"></div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button id="btnNew" class="btn outline">กรอกใหม่</button>
        <button id="btnClose" class="btn">ปิดหน้าต่าง</button>
      </div>
    </section>
  </div>

  <div class="sticky-foot">
    <button id="submitBtn" class="btn">บันทึกข้อมูล</button>
  </div>

<script>
/* ======= ตั้งค่าโปรเจกต์คุณ ======= */
const LIFF_ID    = "2008118596-nMd5qQ38";
const AUTH_URL   = "https://authline-iyipepekja-as.a.run.app";
const CREATE_URL = "https://createissue-iyipepekja-as.a.run.app";
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCnNQdOzThqmT3Wgvir2x4yrpiygKQKbV8",
  authDomain: "finh-iot-ai.firebaseapp.com",
  projectId: "finh-iot-ai"
};
/* ======= จบส่วนตั้งค่า ======= */

const REQUIRED_SCOPE = ['openid','profile','email'];
const $ = (s)=>document.querySelector(s);

// 11 หมวด (สองช้อยส์—ผ่าน/ไม่ผ่าน)
const SECTIONS = [
  { id:1, title:"สถานที่ตั้งฟาร์ม", items:[
    "พื้นที่ตั้งฟาร์มอยู่ใกล้แหล่งมลพิษหรือแหล่งปนเปื้อน เช่น โรงงานอุตสาหกรรม เกษตรกรรมที่ใช้สารเคมี หรือไม่",
    "หากพื้นที่มีความเสี่ยง เจ้าของฟาร์มมีมาตรการป้องกันและบันทึกหลักฐานไว้หรือไม่",
  ]},
  { id:2, title:"การเตรียมบ่อเพาะเลี้ยง", items:[
    "บ่อเลี้ยงมีความแข็งแรงและใช้วัสดุหรือโครงสร้างที่ปลอดภัยต่อผู้บริโภคหรือไม่",
    "มีกระบวนการกำจัดวัชพืชหรือสิ่งแปลกปลอมก่อนเพาะเลี้ยงหรือไม่",
    "หากมีการใช้สารเคมี ผู้ปฏิบัติงานได้ปฏิบัติตามการใช้งานตามฉลากและมีบันทึกการใช้ทุกครั้งหรือไม่",
  ]},
  { id:3, title:"การจัดการน้ำ", items:[
    "น้ำที่ใช้สำหรับการเลี้ยงมาจากแหล่งที่มาที่มีความเสี่ยงต่อการปนเปื้อนของสารเคมี จุลินทรีย์ก่อโรคหรือไม่",
    "มีการตรวจวัดคุณภาพน้ำอย่างสม่ำเสมอ (สี กลิ่น ความใส หรือผลแลบ) และบันทึกข้อมูลไว้หรือไม่",
    "น้ำที่ใช้สำหรับกระบวนการล้างผลผลิต มาจากแหล่งที่มาที่มีความเสี่ยงต่อการปนเปื้อนของสารเคมี จุลินทรีย์ก่อโรคหรือไม่",
  ]},
  { id:4, title:"สุขลักษณะภายในฟาร์ม", items:[
    "มีการจัดการขยะและภาชนะใช้แล้วอย่างเหมาะสมหรือไม่ เช่น การไม่เผา การไม่ใช้ซ้ำ",
    "มีมาตรการป้องกันสัตว์พาหะ เช่น หนู แมลง สัตว์เลี้ยง หรือไม่",
    "มีกระบวนการแยกเก็บปัจจัยการผลิตออกจากพื้นที่เก็บผลผลิตหรือไม่",
  ]},
  { id:5, title:"การจัดการเพาะเลี้ยง", items:[
    "ใช้พันธุ์ผำจากแหล่งที่เชื่อถือได้หรือไม่",
    "มีกระบวนการเฝ้าระวังศัตรูพืช วัชพืชน้ำ และสิ่งแปลกปลอมหรือไม่",
    "มีการบันทึกความผิดปกติที่เกิดขึ้นในกระบวนการเลี้ยงและการแก้ไขเมื่อพบความผิดปกติหรือไม่",
  ]},
  { id:6, title:"ปุ๋ยและธาตุอาหารเสริม", items:[
    "ใช้ปุ๋ยหรือสาร ธาตุอาหารที่ขึ้นทะเบียนถูกต้องและปลอดภัยหรือไม่",
    "มีการใช้มูลสัตว์สดในกระบวนการเพาะเลี้ยงหรือไม่",
    "มีการทำปุ๋ยหมักเองหรือไม่",
    "มีบันทึกบัญชีรายการปุ๋ยและการใช้ครบถ้วนหรือไม่",
  ]},
  { id:7, title:"การจัดการน้ำทิ้งและดินเลน", items:[
    "มีการปล่อยน้ำทิ้งลงสู่แหล่งน้ำสาธารณะโดยตรงหรือไม่",
    "มีมาตรการจัดการ/กักเก็บน้ำทิ้งอย่างถูกต้องหรือไม่",
    "มีกระบวนการกำจัดดินเลนทำอย่างถูกวิธีและไม่ก่อให้เกิดมลภาวะหรือไม่",
  ]},
  { id:8, title:"การเก็บเกี่ยวและหลังเก็บเกี่ยว", items:[
    "ใช้อุปกรณ์เก็บเกี่ยวที่สะอาดและถูกสุขลักษณะหรือไม่",
    "มีการล้างผำด้วยน้ำสะอาดหลังเก็บเกี่ยวหรือไม่",
    "มีการวางผลผลิตบนพื้นดินโดยตรงหรือไม่",
  ]},
  { id:9, title:"การเก็บรักษาและขนส่ง", items:[
    "เก็บผลผลิตในที่สะอาด แห้ง และอากาศถ่ายเทหรือไม่",
    "มีการทำข้อมูลชี้บ่ง เช่น ชื่อผู้ผลิต/แปลง/วันเก็บเกี่ยว ในฟาร์มหรือไม่",
    "มีกระบวนการขนส่งโดยไม่ทำให้ผลผลิตปนเปื้อนหรือเสียหายหรือไม่",
  ]},
  { id:10, title:"ผู้ปฏิบัติงาน", items:[
    "ผู้ปฏิบัติงานผ่านการอบรมสุขลักษณะส่วนบุคคลหรือไม่",
    "ผู้ปฏิบัติงานมีความเข้าใจขั้นตอนการเลี้ยงและการเก็บเกี่ยวหรือไม่",
    "มีหลักฐานการอบรมหรือสอนงานหรือไม่",
  ]},
  { id:11, title:"การบันทึกข้อมูลและเอกสาร", items:[
    "มีบันทึกข้อมูลการใช้ปุ๋ย/สารเคมีหรือไม่",
    "มีบันทึกความผิดปกติและการแก้ไขหรือไม่",
    "มีบันทึกการซื้อพันธุ์หรือไม่",
    "มีบันทึกข้อมูลการเก็บเกี่ยวและขนส่งหรือไม่",
    "เอกสารทุกอย่างเก็บรักษาอย่างน้อย 3 ปี หรือไม่",
  ]},
];

function renderSections(){
  const host = document.querySelector("#sections");
  host.innerHTML = "";
  SECTIONS.forEach(sec=>{
    const secEl = document.createElement("div");
    secEl.className = "sec";
    secEl.innerHTML = `
      <div class="sec-hdr" data-sec="${sec.id}">
        <div><b>${sec.id}. ${sec.title}</b></div>
        <div>▶</div>
      </div>
      <div class="sec-body" id="sec-${sec.id}"></div>
    `;
    host.appendChild(secEl);

    const body = secEl.querySelector(".sec-body");
    sec.items.forEach((text, idx)=>{
      const qId = `${sec.id}_${idx+1}`;
      const q = document.createElement("div");
      q.className = "q";
      q.innerHTML = `
        <div class="q-title">${sec.id}.${idx+1} ${text}</div>
        <div class="q-grid">
          <div class="row">
            <label class="inline"><input type="radio" name="pass_${qId}" value="PASS"> ผ่าน</label>
            <label class="inline"><input type="radio" name="pass_${qId}" value="FAIL"> ไม่ผ่าน</label>
          </div>
        </div>
      `;
      body.appendChild(q);
    });
  });

  // toggle accordion
  host.querySelectorAll(".sec-hdr").forEach(h=>{
    h.addEventListener("click", ()=>{
      const body = h.nextElementSibling;
      body.style.display = (body.style.display === "block") ? "none" : "block";
    });
  });

  // เปิดหมวดแรก
  const first = host.querySelector(".sec-body");
  if (first) first.style.display = "block";
}

// ==== Auth helpers ====
async function getFreshLineIdToken(){
  if (!liff.isLoggedIn()) {
    liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href });
    return new Promise(()=>{});
  }
  const idToken = liff.getIDToken();
  const decoded = liff.getDecodedIDToken?.();
  if (!idToken || !decoded) { liff.logout(); liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href }); return new Promise(()=>{}); }
  const expMs = (decoded.exp||0)*1000;
  if (Date.now() > expMs - 15000) { liff.logout(); liff.login({ scope: REQUIRED_SCOPE, redirectUri: location.href }); return new Promise(()=>{}); }
  return idToken;
}

async function exchangeToFirebaseToken(lineIdToken){
  const r = await fetch(AUTH_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ idToken: lineIdToken })
  });
  let js = null;
  try { js = await r.json(); } catch {}
  if (!r.ok) {
    const msg = `${js?.error ?? ''}${js?.message ? `: ${js.message}` : ''}`.trim() || `authLine HTTP ${r.status}`;
    throw new Error(msg);
  }
  return js.firebaseToken;
}

// ==== เก็บคำตอบ ====
function collectAuditData(){
  const farmId = (document.querySelector("#farmId").value || "").trim() || null;
  const plotId = (document.querySelector("#plotId").value || "").trim() || null;
  const answers = [];
  SECTIONS.forEach(sec=>{
    sec.items.forEach((text, idx)=>{
      const qId = `${sec.id}_${idx+1}`;
      const val = (document.querySelector(`input[name="pass_${qId}"]:checked`)||{}).value || null;
      answers.push({ sectionId: sec.id, sectionTitle: sec.title, itemNo: `${sec.id}.${idx+1}`, text, result: val });
    });
  });
  return { farmId, plotId, answers };
}

// ==== สรุปผล & แสดงกราฟ ====
function summarizeAnswers(answers){
  let pass=0, fail=0, na=0;
  for (const a of answers) {
    if (a.result === "PASS") pass++;
    else if (a.result === "FAIL") fail++;
    else na++;
  }
  const total = answers.length || 0;
  const pctPass = total ? Math.round((pass/total)*100) : 0;
  const pctFail = total ? Math.round((fail/total)*100) : 0;
  const pctNA   = total ? Math.max(0, 100 - pctPass - pctFail) : 0;
  return { pass, fail, na, total, pctPass, pctFail, pctNA };
}

let _pieInstance = null;
function showResult(summary, issueId=null, backendErrorMsg=null){
  // ซ่อนฟอร์ม + ปุ่มส่ง
  document.querySelector("#auditForm").style.display = "none";
  document.querySelector(".sticky-foot").style.display = "none";

  // อัปเดตสถิติ
  const statsHost = document.querySelector("#resultStats");
  statsHost.innerHTML = `
    <span class="pill">ผ่าน: ${summary.pass}/${summary.total} (${summary.pctPass}%)</span>
    <span class="pill">ไม่ผ่าน: ${summary.fail}/${summary.total} (${summary.pctFail}%)</span>
    <span class="pill">ยังไม่ตอบ: ${summary.na}</span>
  `;

  const msg = backendErrorMsg
    ? `* ไม่สามารถบันทึกข้อมูลไปยังระบบได้: ${backendErrorMsg}`
    : issueId
      ? `บันทึกข้อมูลเรียบร้อย (รหัส: ${issueId})`
      : `แสดงสรุปจากคำตอบบนหน้านี้`;
  document.querySelector("#resultMsg").textContent = msg;

  // วาด pie
  const ctx = document.getElementById("pieCanvas").getContext("2d");
  if (_pieInstance) { _pieInstance.destroy(); }
  _pieInstance = new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["ผ่าน", "ไม่ผ่าน", "ยังไม่ตอบ"],
      datasets: [{
        data: [summary.pass, summary.fail, summary.na]
      }]
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        tooltip: { callbacks: {
          label: (c)=> `${c.label}: ${c.raw} ข้อ`
        }}
      }
    }
  });

  // แสดงการ์ดผลลัพธ์
  document.querySelector("#resultCard").style.display = "block";
}

// reset หน้าฟอร์ม (ไม่ลบค่า input ฟาร์ม/แปลงเพื่อกรอกซ้ำง่าย)
function resetForm(){
  // เคลียร์คำตอบ radio
  document.querySelectorAll('input[type="radio"]').forEach(r=> r.checked = false);
  document.querySelector("#consent").checked = false;

  document.querySelector("#resultCard").style.display = "none";
  document.querySelector("#auditForm").style.display = "block";
  document.querySelector(".sticky-foot").style.display = "flex";
}

// ==== main ====
window.addEventListener('DOMContentLoaded', async () => {
  renderSections();

  // ปุ่มผลลัพธ์
  document.querySelector("#btnNew").onclick = resetForm;
  document.querySelector("#btnClose").onclick = ()=> {
    if (liff.isInClient()) liff.closeWindow();
    else window.close();
  };

  try {
    await liff.init({ liffId: LIFF_ID });
    const lineIdToken = await getFreshLineIdToken();

    // โปรไฟล์
    const prof = await liff.getProfile();
    document.querySelector("#uimg").src = prof.pictureUrl || "";
    document.querySelector("#uname").textContent = prof.displayName || "LINE User";
    document.querySelector("#uid").textContent = `uid: ${prof.userId}`;
    document.querySelector("#logout").onclick = ()=>{ liff.logout(); location.reload(); };

    // แลก custom token + sign in Firebase
    const firebaseToken = await exchangeToFirebaseToken(lineIdToken);
    if (!firebase.apps?.length) firebase.initializeApp(FIREBASE_CONFIG);
    await firebase.auth().signInWithCustomToken(firebaseToken);

    // ปุ่มบันทึก
    const btn = document.querySelector("#submitBtn");
    btn.onclick = async ()=>{
      try{
        if (!document.querySelector("#consent").checked) return alert("กรุณายินยอมก่อนส่ง");

        btn.disabled = true; btn.textContent = "กำลังบันทึก...";

        const { farmId, plotId, answers } = collectAuditData();
        const fbIdToken = await firebase.auth().currentUser.getIdToken(true);
        const payload = {
          farmId, plotId,
          description: "GAqP self-audit (data-only)",
          consent: true,
          auditAnswers: answers
        };

        let issueId = null;
        try {
          const r = await fetch(CREATE_URL, {
            method:"POST",
            headers: { "Content-Type":"application/json", "Authorization": "Bearer " + fbIdToken },
            body: JSON.stringify(payload)
          });
          const js = await r.json().catch(()=> ({}));
          if (!r.ok) throw new Error(js?.error || r.statusText || "บันทึกไม่สำเร็จ");
          issueId = js.issueId || null;
        } catch (e) {
          // ถ้าบันทึกพัง ก็ยังสรุปผลให้ผู้ใช้เห็น
          const sum = summarizeAnswers(answers);
          showResult(sum, null, e.message || "NETWORK/ERROR");
          return;
        } finally {
          btn.disabled = false; btn.textContent = "บันทึกข้อมูล";
        }

        const sum = summarizeAnswers(answers);
        showResult(sum, issueId, null);

      }catch(e){
        console.error(e);
        alert(e.message || "บันทึกไม่สำเร็จ");
        btn.disabled = false; btn.textContent = "บันทึกข้อมูล";
      }
    };

  } catch (err) {
    console.error(err);
    alert(err.message || "เริ่มต้นระบบไม่สำเร็จ");
  }
});
</script>
</body>
</html>
