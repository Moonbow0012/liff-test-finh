<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>แบบสอบถามปัญหาฟาร์ม</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
</head>
<body>
  <header class="hdr">
    <!-- ซ่อนโลโก้ถ้าไฟล์ไม่มี -->
    <img src="./finh_logo.png" alt="logo" class="logo" onerror="this.style.display='none'"/>
    <h1>แจ้งปัญหาฟาร์ม</h1>
  </header>

  <section id="userCard" class="card user">
    <img id="uimg" class="avatar" alt="avatar"/>
    <div>
      <div id="uname" class="name">...</div>
      <div id="uid" class="uid muted">uid: -</div>
    </div>
    <button id="logout" class="btn outline">ออกจากระบบ</button>
  </section>

  <form id="f" class="card form">
    <div class="row">
      <label>ฟาร์ม (farmId)<input name="farmId" required placeholder="เช่น farm-1"></label>
      <label>แปลง (plotId)<input name="plotId" required placeholder="เช่น P01"></label>
    </div>

    <div class="row">
      <label>ชนิดพืช (crop)<input name="crop" placeholder="เช่น lettuce"></label>
      <label>รุ่นผลิต (batch)<input name="batch" placeholder="เช่น 2025-09-A"></label>
    </div>

    <label>ประเภทปัญหา
      <select name="category" required>
        <option value="">-- เลือก --</option>
        <option>WEED</option><option>PEST</option>
        <option>DISEASE</option><option>NUTRIENT</option>
        <option>OTHER</option>
      </select>
    </label>

    <label>ความรุนแรง (1-5)
      <input type="number" name="severity" min="1" max="5" value="1" required>
    </label>

    <label>รายละเอียด
      <textarea name="description" rows="3" required></textarea>
    </label>

    <div class="row">
      <label>วิธีแก้ / แผนดำเนินการ<input name="actionPlan"></label>
      <label>สาร/ผลิตภัณฑ์ที่ใช้<input name="productUsed"></label>
    </div>

    <div class="row">
      <label>อัตราใช้ (dose)<input name="dose" placeholder="เช่น 60 ml/20L"></label>
      <label>PHI (วัน)<input type="number" name="phiDays" min="0"></label>
    </div>

    <div class="row">
      <label>ละติจูด (lat)<input id="lat" name="lat" placeholder="16.12345"></label>
      <label>ลองจิจูด (lng)<input id="lng" name="lng" placeholder="103.12345"></label>
    </div>
    <button type="button" id="btnGeo" class="btn ghost">ดึงพิกัด</button>

    <label>รูปภาพ (ได้หลายรูป)
      <input type="file" id="photos" accept="image/*" capture="environment" multiple>
    </label>
    <div id="pv" class="preview"></div>

    <label class="consent">
      <input type="checkbox" id="consent" required> ยินยอมให้เก็บและใช้ข้อมูลตาม Privacy Notice
    </label>

    <button class="btn primary" type="submit">ส่งรายงาน</button>
  </form>

<script>
  // ===== CONFIG =====
  const LIFF_ID    = "2008118596-nMd5qQ38"; // <- LIFF ID ของคุณ
  const AUTH_URL   = "https://authline-iyipepekja-as.a.run.app";    // จาก `firebase functions:list`
  const CREATE_URL = "https://createissue-iyipepekja-as.a.run.app"; // จาก `firebase functions:list`
  const FIREBASE_CONFIG = {
    apiKey: "xxx",
    authDomain: "xxx.firebaseapp.com",
    projectId: "xxx",
    storageBucket: "xxx.appspot.com"
  };
  const REQUIRED_SCOPE = ['openid','profile','email'];

  // ===== Helpers =====
  const $ = (s)=>document.querySelector(s);
  const LOGIN_FLAG = "fromLogin";
  const RELOGIN_ONCE_KEY = "liff.relogin.once.v2";

  function curUrl(withFlagVal=null){
    const u = new URL(location.href);
    if (withFlagVal == null) u.searchParams.delete(LOGIN_FLAG);
    else u.searchParams.set(LOGIN_FLAG, withFlagVal);
    return u.toString();
  }
  function clearLoginFlagIfPresent(){
    const u = new URL(location.href);
    if (u.searchParams.get(LOGIN_FLAG)) {
      u.searchParams.delete(LOGIN_FLAG);
      history.replaceState({}, "", u.toString());
      sessionStorage.removeItem(RELOGIN_ONCE_KEY);
    }
  }
  function alreadyReloggedOnce(){
    const t = Number(sessionStorage.getItem(RELOGIN_ONCE_KEY) || "0");
    // ป้องกันลูป: อนุญาตให้รีได้ 1 ครั้งต่อการโหลดหน้า (หรือถ้าเกิน 2 นาทีถือว่าเริ่มใหม่)
    return t && (Date.now() - t < 120000);
  }
  function markRelogin(){
    sessionStorage.setItem(RELOGIN_ONCE_KEY, String(Date.now()));
  }

  async function relogin({forceLogout=false, reason="unknown"} = {}){
    if (alreadyReloggedOnce()) {
      alert("รับรองตัวตนไม่สำเร็จ (กันลูป). โปรดปิดแท็บแล้วเปิดใหม่อีกครั้ง");
      throw new Error("Relogin blocked: already attempted. reason="+reason);
    }
    if (forceLogout) try { liff.logout(); } catch {}
    markRelogin();
    const redirectUri = curUrl("1");
    liff.login({ scope: REQUIRED_SCOPE, redirectUri });
    return new Promise(()=>{}); // จะ redirect ออกไป
  }

  // เอา id_token สด ๆ ถ้าไม่มี/หมดอายุ -> re-login (1 ครั้ง)
  async function getFreshIdTokenOrRelogin() {
    if (!liff.isLoggedIn()) return relogin({ reason: "not-logged-in" });

    let idToken = liff.getIDToken();
    let decoded = null;
    try { decoded = liff.getDecodedIDToken?.(); } catch {}

    // ถ้าไม่มี token/ถอดไม่ได้ -> re-login
    if (!idToken || !decoded) return relogin({ forceLogout:true, reason:"no-token" });

    // เช็คหมดอายุ: เผื่อ margin 15 วินาที
    const expMs = (decoded.exp ? decoded.exp*1000 : 0);
    if (Date.now() > expMs - 15000) {
      return relogin({ forceLogout:true, reason:"expired-or-near" });
    }
    return { idToken, decoded };
  }

  async function exchangeToFirebaseToken(idToken){
    const r = await fetch(AUTH_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ idToken })
    });
    const txt = await r.text();
    let js = {}; try { js = JSON.parse(txt); } catch {}
    console.log("authLine response:", r.status, js || txt);

    if (!r.ok) {
      const msg = (js?.error || txt || "");
      // ถ้า backend บอก expired -> บังคับรีล็อกอิน 1 ครั้ง
      if ((js?.where === "authLine/verify") && msg.toLowerCase().includes("expired")) {
        return relogin({ forceLogout:true, reason:"backend-says-expired" });
      }
      throw new Error("authLine failed: " + msg);
    }
    return js.firebaseToken;
  }

  // ===== Image utils =====
  const resizeImage = (file, maxSize=1600, q=0.85)=>new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.min(1, maxSize/Math.max(img.width, img.height));
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      c.toBlob(b=>resolve(b),'image/jpeg',q);
    };
    img.src = URL.createObjectURL(file);
  });

  // ===== MAIN =====
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      await liff.init({ liffId: LIFF_ID });

      // ล้าง flag เมื่อตีกลับจาก LINE แล้ว
      clearLoginFlagIfPresent();

      // 1) ขอ id_token สด (รี-ล็อกอิน 1 ครั้งถ้าจำเป็น)
      const { idToken, decoded } = await getFreshIdTokenOrRelogin();
      console.log("Decoded ID token:", decoded);

      // 2) แสดงโปรไฟล์
      const prof = await liff.getProfile();
      $("#uimg").src = prof.pictureUrl || "";
      $("#uname").textContent = prof.displayName || "LINE User";
      $("#uid").textContent = `uid: ${prof.userId}`;
      $("#logout").onclick = ()=> { liff.logout(); location.reload(); };

      // 3) แลกเป็น Firebase Custom Token
      const firebaseToken = await exchangeToFirebaseToken(idToken);
      firebase.initializeApp(FIREBASE_CONFIG);
      await firebase.auth().signInWithCustomToken(firebaseToken);

      // 4) UI extras
      $("#btnGeo").onclick = ()=>navigator.geolocation.getCurrentPosition(
        p=>{ $("#lat").value=p.coords.latitude.toFixed(6); $("#lng").value=p.coords.longitude.toFixed(6); },
        ()=>alert("ดึงพิกัดไม่สำเร็จ")
      );
      $("#photos").addEventListener('change', e=>{
        const files=e.target.files; const pv=$("#pv"); pv.innerHTML="";
        [...files].forEach(f=>{ const im=document.createElement('img'); im.src=URL.createObjectURL(f); pv.appendChild(im); });
      });

      // 5) ส่งฟอร์ม
      $("#f").addEventListener('submit', async (e)=>{
        e.preventDefault();
        try {
          if (!$("#consent").checked) return alert("กรุณายินยอมก่อนส่ง");

          // ขอ id_token สดอีกรอบก่อนยิง backend (กันหมดอายุระหว่างหน้าเปิด)
          const fresh = await getFreshIdTokenOrRelogin();
          const freshIdToken = fresh.idToken;

          const fd = new FormData(e.target);
          const n = (v)=> (v === "" || v === null) ? null : Number(v);
          const payload = {
            farmId: fd.get("farmId"),
            plotId: fd.get("plotId"),
            crop: fd.get("crop") || null,
            batch: fd.get("batch") || null,
            category: fd.get("category"),
            severity: Number(fd.get("severity") || 1),
            description: fd.get("description"),
            actionPlan: fd.get("actionPlan") || null,
            productUsed: fd.get("productUsed") || null,
            dose: fd.get("dose") || null,
            phiDays: n(fd.get("phiDays")),
            geo: (()=> {
              const lat = parseFloat(fd.get("lat")); const lng = parseFloat(fd.get("lng"));
              return (Number.isFinite(lat) && Number.isFinite(lng)) ? { lat, lng } : null;
            })(),
            consent: true
          };

          // 5.1) createIssue
          const r = await fetch(CREATE_URL, {
            method:"POST",
            headers: {
              "Content-Type":"application/json",
              "Authorization":"Bearer "+freshIdToken
            },
            body: JSON.stringify(payload)
          });
          const txt = await r.text(); let js = {}; try{ js = JSON.parse(txt); }catch{}
          console.log("createIssue response:", r.status, js || txt);
          if (!r.ok) {
            const msg = (js?.error || txt || "");
            if ((js?.where === "createIssue/verify") && msg.toLowerCase().includes("expired")) {
              return relogin({ forceLogout:true, reason:"createIssue-expired" });
            }
            throw new Error("createIssue failed: " + msg);
          }
          const { issueId, uploadPrefix } = js;

          // 5.2) upload photos
          const files = $("#photos").files;
          if (files.length){
            const storage = firebase.storage().ref();
            for (const f of files){
              const blob = await resizeImage(f);
              const safe = f.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9._-]/g, '');
              const path = `${uploadPrefix}/original/${Date.now()}-${safe}`;
              await storage.child(path).put(blob, { contentType:"image/jpeg" });
            }
          }

          alert(`ส่งเรียบร้อย (เลขอ้างอิง: ${issueId})`);
          if (liff.isInClient()) liff.closeWindow();
        } catch (err) {
          console.error(err);
          alert(err.message || "ส่งไม่สำเร็จ");
        }
      });
    } catch (err) {
      console.error(err);
      alert(err.message || "เริ่มต้นระบบไม่สำเร็จ");
    }
  });
</script>
</body>
</html>
